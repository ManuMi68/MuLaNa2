---
title: "NeuralSpatial: Statistics for Distinct neural mechanisms for heading retrieval and context recognition in the hippocampus during spatial reorientation"
author: "Manuel Miguel Ramos Álvarez and the Muzzio Lab"
date: "`r format(Sys.time(), '%B %d, %Y')`"
format:
  html:
    code_download: true
    toc: true
    toc-location: left
    toc-depth: 4
    number-sections: true
    code-fold: true
    code-tools: true
    code-summary: "Code"
    code-overflow: scroll
    theme: cosmo
    page-layout: full
    grid:
      sidebar-width: 250px
      body-width: 900px
      margin-width: 300px
      gutter-width: 1.5rem
editor: visual
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
 library(knitr)
 knitr::knit_hooks$set(optipng = knitr::hook_optipng)
 knitr::opts_chunk$set(echo = TRUE,comment = "",error=FALSE, warning = FALSE, message = FALSE, fig.show='hold',results='hold', collapse = TRUE, optipng='-o7')
```

```{css, echo=FALSE}
.watch-out {
  background-color: #FFECEE;
  border: 1px solid gray;
}
```

```{css, echo=FALSE}
.main-container {
    max-height: 800px !important;
    overflow-y: scroll !important;
    overflow-x: auto !important;
}

pre {
  max-height: 800px !important;
  overflow-y: scroll !important;
  overflow-x: auto !important;
}
pre code {
  max-height: 800px !important;
  overflow-y: scroll !important;
  overflow-x: auto !important;
}
```

# Preliminars: Packages, functions, and data preload {.unnumbered}

```{r prelim, warning=FALSE, message=FALSE}

source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))

```

```{r ResCtrl1, eval=F, echo=FALSE, comment=""}
    # Results
    kableTabl(ezPrecis(DTp),"Design Structure", "")
    cat("---------------------\n");
    cat("Data Structure:\n");
      str(DTp) # Data File
    cat("---------------------\n");
      print(DTp)
    cat("---------------------\n");
      kableTabl(DTRes,"Descriptive", "")
    cat("Omnibus AOV:\n")
      a0
    cat("---------------------\n");
    cat("Pos Hoc Simple Effects:\n")
      PosH.4w$PosHocMM
    #kableTabl(PosH.4w$PosHocMM,"Pos Hoc Simple Effects", "")
    cat("---------------------\n");
    kableTabl(PosH.4w$Means,"Descrptive & CI-95%", "")
    cat("---------------------\n");
    # cat("Graphics have been preloaded to avoid page overload\n (see the corresponding section for details).:\n");
    cat("Exploratory Analysis:\n")
    cat(Grp) # Exploratory Analysis
    cat("\n")
```

# **Results Section 1.** Reorienting behavior in a two-context paradigm

## **Figure 1. Reorientation behavior in a two-context paradigm**

------------------------------------------------------------------------

> **Figure 1.** Reorientation behavior in a two-context paradigm. A) Schematic of experimental chambers showing reward location (yellow star) in Context A (left) and Context B (right). B) Schematic of session structure of two-context paradigm. Animals (N = 14) are disoriented before being placed in each context, in alternating order on 12 consecutive trials. C) Percentage of digs in each cup location on test trials on day 1 (left), day 2 (center), and day 3 (right). Standard error of the mean is shown in parentheses below the mean percentage values. D) Boxplots showing distribution of digs in geometrically correct vs. incorrect axes in each context. E) Boxplots showing distribution of digs in each cup location combining both contexts. In all boxplots graphs, the boxes indicate the upper and lower quartiles of the data and the whiskers (extending lines) the minimum and maximum outside the quartiles. The horizontal line indicates the median. Dots represent individual data points and asterisks (\*) indicate p \< 0.05. F) Cumulative proportion of Bayes Factor (BF) on days 1 to 3 per context evaluating the alternative model (MAlt) that animals preferentially dug on a distinct rewarded axis in each context vs. the null model (Mnull) that animals dug by chance. The global BF showed credibility in support of MAlt in each context across days \[Context A: group BFs (days 1, 2, and 3): 4.16, 7.23 and 6.94; Context B: group BFs (days 1, 2, and 3): 4.18, 8.60, and 8.56; for details on individual data see Table S2\]. Note that in both contexts the group BFs are \>1.1 indicating credibility for learning. Moreover, the point at which the cumulative proportion intercepts the dotted line at 0 shows that even though there are some subtle differences in the rate of learning on day 2, these differences decrease on day 3 (Percentages on negative values: Day 2: context A: 28.57%, Context B: 7.14%; Day 3: Context A: 35.71%, Context B: 21.43%).G) Cumulative proportion of individual Bayes Factors (BF) across days 1 to 3 combining contexts evaluating the alternative model (MAlt) that animals increased digging in C locations with experience vs. the null model (Mnull) that animals dug by chance. Global BFs indicate that animals do not preferentially dig in the C cup on day 1 (Group BF=-2.60), favoring Mnull. However, MAlt is favored on Days 2 and 3 (Group BF= 15.06 and 17.68, respectively), favoring the model that supports increased digging in the C cup location. Conventional values showing the border marking credibility for Malt (log(BF) \> log(1/3)= 1.1) and Mnull (log(BF) \< log(1/3)= -1.1) are indicated by vertical dashed lines. The value of half (0.5) of the sample is marked by a horizontal dashed line.

------------------------------------------------------------------------

### Fig 1C) Percentage of digs in each cup location on test trials across days

![Figure 1C](images/Fig1C.png){width="527"}

```{r F1C, collapse = FALSE}

  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig1")
  Mk.dir(NmRoo)
  DT.BF <-copy(DigBehavioralDataForBF)

  DT.Perc<-data.table(copy(DT.BF)) %>%
    dplyr::rename(., Context=Group) %>%
    mutate(Dig = dplyr::recode(Dig, C = "C",G = "G", F = "N", W="F")) %>%
    .[, data.table(table(Subj,Dig)),by=.(Context,Day)] %>%
    .[,Perc:=N/sum(N),by=list(Subj,Context,Day)]  %>%
    .[,.(MeanPerc=percent(mean(Perc),0), SEMPerc=percent(sd(Perc)/sqrt(length(Perc)),1) ), by=.(Context, Day, Dig)] %>%
    mutate_at(c("Dig"),factor) %>%
    as.data.table() %>%
    setkey(., Context, Day, Dig)
  
  cat("Percents of Figure 1C:\n")
  DT.Perc
  
  
```

### Fig 1D) Boxplots of digs in geometrically correct vs. incorrect axes in each context

{Design (2 Axis x S) x (3 Day x S) x (2 Context x S)}

![Figure 1D (see `Grp.1D` code to generate this image)](images/Fig1D.png){width="400"}

```{r F1D, warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig1")
  Mk.dir(NmRoo)
  
  #DT1 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/BehavTwoContext.RDS")))
  DTp<-copy(BehavTwoContext)
  
  
  # "Fig.1D) has been preloaded to avoid overloading problems
  # Box Plot
    ColPer=c("#D599D7", "#AA33B0","#700075")
    Grp.1D<- Grph.2023(
      DatP = DTp,
        Dvp="Proportion", VarX="Context",VarFill="Day",
        LblsP =c("Cluster Quality", "","Dig Percent Per Animal",""),
        ylmP =c(0,100),hLin = F,lvIp = 4,GrpSel = c(1:3),wMain=F,
      TyGrp="Box", # Bar, Box, Violin, SplitViolin
      Wthdot=T, Relleno=T, ResumAd=T,ColPer=ColPer
    ) 
   Grp.1D <- Grp.1D + facet_grid( ~ Axis)
   ggsave(paste0(NmRoo,"/Fig1D.pdf"), Grp.1D, width=10, height=10)
   
   
# Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Proportion', by=.(Axis,Day,Context)]
  #DTRes<-DTp[,c(N = .N,as.list(summary(Proportion))), by=.(Axis,Day,Context)]
  write.csv2(DTRes,paste0(NmRoo, "/BehavTwoContext_Descriptive.csv"))
 
 
# AOV
  a0 <- aov_ez("Subject", "Proportion", DTp,
        within = c("Axis","Context","Day"))
  
  # Effect size & Mixed
  eef<-effectsize::eta_squared(a0, generalized=TRUE)
  Mod.1r<-lmer(Proportion~Day * Axis * Context + (1|Subject),data=DTp)
  
  # Pos Hoc of the more complex significant effect: Axis:Context
  # Defines orthogonal contrasts from a prioristic perspective
  custom <- list(`Unique` = c(1, -1))
  PosH.4w = PosHocAut(a0, Mod.1r, "Axis|Context", c("Context","emmean"), custom=custom)
  # Since the focal variable has only two levels, the Rom correction is not necessary  
  
  Grp<-"Run Grp.1D"
  # Grp.1D
  <<ResCtrl1>>
```

### Fig 1E) Boxplots of digs in each cup location combining both contexts

{Design (4 Dig x S) x (3 Day x S)}

![Figure 1E (see `Grp.1E` code to generate this image)](images/Fig1E.png){width="400"}

```{r F1E, warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig1")
  Mk.dir(NmRoo)
  #DT2 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/DigBehavioralData.RDS")))
  DTp<-copy(DigBehavioralData)
  
# Fig.1E) Box Plot
    ColPer=c("#D599D7", "#AA33B0","#700075")
    Grp.1E<- Grph.2023(
      DatP = DTp,
      Dvp="Perc", VarX="Dig", VarFill="Day",
      LblsP =c("Cluster Quality", "","Dig Percent Per Animal","Location of first dig"),
      ylmP =c(0,100),hLin = F,lvIp = 4,GrpSel = c(1:3),wMain=F,
      TyGrp="Box", # Bar, Box, Violin, SplitViolin
      Wthdot=T, Relleno=T, ResumAd=T,ColPer=ColPer
    )
    ggsave(paste0(NmRoo,"/Fig1E.pdf"), Grp.1E, width=10, height=10)
  
# Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Perc', by=.(Dig,Day)]
  #DTRes<-DTp[,c(N = .N,as.list(summary(Perc))), by=.(Dig,Day)]
  write.csv2(DTRes,paste0(NmRoo, "/DigBehavioralData_Descriptive.csv"))
  
# AOV
  a0 <- aov_ez("Subject", "Perc", DTp,
        within = c("Dig","Day"))
  
  # Effect size & Mixed
  eef<-effectsize::eta_squared(a0, generalized=TRUE)
  Mod.1r<-lmer(Perc~Day * Dig + (1|Subject),data=DTp)
    
  
# Pos Hoc
  # Defines orthogonal contrasts from a prioristic perspective
  custom <- list(`CG vs NF` = c(1, 1,-1,-1),
                     `C vs G` = c(1,-1, 0, 0),
                    `N vs F` = c(0, 0, 1,-1)
                 )
  PosH.4w = PosHocAut(a0, Mod.1r, "Dig|Day", c("Day","emmean"), custom=custom)
  Grp<-"Run Grp.1E code"
  # Grp.1E
  <<ResCtrl1>> 
```

### Fig 1F) Cumulative proportion of Bayes Factor (BF) on days 1 to 3 per context

![Figure 1F (see `Res.50$GrpDay$All` code to generate this image)](images/Fig1F.png){width="400"}

```{r F1F, warning=FALSE, message=FALSE, collapse=FALSE, out.width="1000px", out.height="800px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig1")
  Mk.dir(NmRoo)
  ValsBF2=seq(-2, 2, by=1.0)
  logEs10=F
  if (logEs10)  ValsBF=sort(c(seq(-2,2,by=.5),-log10(3),log10(3),-.01))
  if (!logEs10) ValsBF=sort(c(seq(-2,2,by=.5),-log(3),log(3),-.01))
  # unique(DT.BF$Subj) AK42   AK74   JJ9    HG1    K1     MG1    CMG159 CMG089 CMG129 CMG154 CMG162 CMG161 CMG169 CMG087
  Nsj=14; LgSess=12
  nFi=Nsj*LgSess*2+Nsj*4 # Check Files: 392
  #DT.BF <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/DigBehavioralDataForBF.RDS")))
  DT.BF <-copy(DigBehavioralDataForBF)
  
  # Process the data to test:
   # the alternative model (MAlt) that animals preferentially dug on the rewarded axis
   # in each context (long wall right in Context A and long wall left in Context B) vs.
   # the null model (Mnull) that animals dug by chance (50%).
   # Note especially line:  .[,BF:=BayNormRam(z,N,li=.5,ls=.9,Nulo=.5),by=list(Group,Day,Subj)] 
  DT.50<-data.table(copy(DT.BF)) %>%
        .[,AxisMM :=Dig] %>% .[,HitsMM :=Dig] %>%
        mutate(AxisMM = dplyr::recode(AxisMM, C = "C/G",F = "N/W", G = "C/G", W="N/W")) %>%
        mutate(HitsMM = dplyr::recode(HitsMM, C = "1",  F = "0",   G = "1",   W="0")) %>%
        mutate(HitsMM = as.numeric(as.character(HitsMM))) %>%
        data.table() %>%
        .[, data.table(table(Subj,Day,AxisMM)),by=Group] %>%
        .[,Perc:=N/sum(N),by=list(Group,Subj,Day)] %>%
        .[,zz:=sum(N),by=list(Group,Subj,Day)] %>%
        .[AxisMM=="C/G"] %>%
        .[,Inter:=interaction(Group,Day)] %>%
        dplyr::rename(., z=N) %>%
        dplyr::rename(., N=zz) %>%
        .[,BF:=BayNormRam(z,N,li=.5,ls=.9,Nulo=.5),by=list(Group,Day,Subj)] %>%
        .[,InterBF:=InterpBF(BF),by=list(Group,Day,Subj)] %>%
        IfFilterLog(.,Fs = logEs10) %>%
        .[, ecdfr := lapply(.SD, function(z) stats::ecdf(z)(z)), .SDcols = "logBF", by = .(Group,Day) ] %>%
        mutate(Day=factor(Day)) %>%
        dplyr::rename(., Subject=Subj)  %>%
        as.data.table()
  
  # Overall results and Fig. 1F
  Res.50 = MakeBF(DT.50, paste0(NmRoo, "/50Chan"))
  cat("BF Overall results of Fig. 1F:\n")
  Res.50$Global
  cat("Run Res.50$GrpDay$All code for Fig. 1F :\n")
  # To View Fig.1F:
  # Res.50$GrpDay$All
```

### Table S1) Complement of Figure 1. Individual data points corresponding to Figure 1C showing percent of digs in each cup per context

```{r TS1}
    # To obtain the percentages data  
    DTPerc<- data.table(copy(DT.BF)) %>%
          .[, data.table(table(Subj,Day,Dig)),by=Group] %>%
          .[,Perc:=percent(N/sum(N)),by=list(Group,Subj,Day)] %>%
          mutate(N=NULL)  %>%
          data.table()
   # To obtain the percentages data in wide format   
    DTFPivot<-DTPerc %>%
          pivot_wider(names_from = c(Dig, Group), values_from = Perc, names_vary = "slowest")
    kableTabl(DTFPivot,"percent of digs in each cup per context", "Table S1. Complement of Figure 1")
    write.csv2(DTFPivot,paste0(NmRoo,"/DigPercents.csv"))
```

### Table S2) Individual Data of Fig.1F)

```{r TS2, warning=FALSE, message=FALSE, collapse=FALSE}

  DT.50[, .(Group,Day,Subject, logBF) ]
```

### Fig 1G) Cumulative proportion of individual Bayes Factors (BF) across days 1 to 3 combining contexts

![Figure 1G (see `Res.25.NoCx$GrpDay` code to generate this image)](images/Fig1G.png){width="400"}

```{r F1G, warning=FALSE, message=FALSE, collapse=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig1")
  Mk.dir(NmRoo)
  ValsBF2=seq(-2, 2, by=1.0)
  logEs10=F
  if (logEs10)  ValsBF=sort(c(seq(-2,2,by=.5),-log10(3),log10(3),-.01))
  if (!logEs10) ValsBF=sort(c(seq(-2,2,by=.5),-log(3),log(3),-.01))
  # unique(DT.BF$Subj) AK42   AK74   JJ9    HG1    K1     MG1    CMG159 CMG089 CMG129 CMG154 CMG162 CMG161 CMG169 CMG087
  Nsj=14; LgSess=12
  nFi=Nsj*LgSess*2+Nsj*4 # Check Files: 392
  #DT.BF <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/DigBehavioralDataForBF.RDS")))
  DT.BF <-copy(DigBehavioralDataForBF)
 
  # Process the data to test:
     # the alternative model (MAlt) that animals dug in the rewarded cup location vs.
     # the null model (Mnull) that animals dug by chance (25%).
     # Note especially line:  .[,BF:=BayNormRam(z,N,li=.25,ls=.9,Nulo=.25),by=list(Day,Subj)]
  DT.25.NoCx<-data.table(copy(DT.BF)) %>%
        .[,AxisMM :=Dig] %>% .[,HitsMM :=Dig] %>%
        mutate(AxisMM = dplyr::recode(AxisMM, C = "C/G",F = "N/W", G = "N/W", W="N/W")) %>%
        mutate(HitsMM = dplyr::recode(HitsMM, C = "1",  F = "0",   G = "0",   W="0")) %>%
        mutate(HitsMM = as.numeric(as.character(HitsMM))) %>%
        data.table() %>%
        .[, data.table(table(Subj,AxisMM)),by=Day] %>%
        .[,Perc:=N/sum(N),by=list(Day,Subj)] %>%
        .[,zz:=sum(N),by=list(Day, Subj)] %>%
        .[AxisMM=="C/G"] %>%
        .[,Inter:=Day] %>%
        dplyr::rename(., z=N) %>%
        dplyr::rename(., N=zz) %>%
        .[,BF:=BayNormRam(z,N,li=.25,ls=.9,Nulo=.25),by=list(Day,Subj)] %>%
        .[,InterBF:=InterpBF(BF),by=list(Day,Subj)] %>%
         IfFilterLog2(.,Fs = logEs10) %>%
        .[, ecdfr := lapply(.SD, function(z) stats::ecdf(z)(z)), .SDcols = "logBF", by = .(Day) ] %>%
        mutate(Day=factor(Day)) %>%
        dplyr::rename(., Subject=Subj)  %>%
        as.data.table()
  
  # Overall results and Fig. 1G
  Res.25.NoCx = MakeBFNoCx(DT.25.NoCx, paste0(NmRoo, "/25Chan_FolCx"))
  cat("BF Overall results of Fig. 1G:\n")
  Res.25.NoCx$Global
  cat("Run Res.25.NoCx$GrpDay code for Fig. 1G:\n")
  # To view Figure 1G:
  # Res.25.NoCx$GrpDay
```

### Table S3) Individual Data of Fig.1G).

```{r TS3, warning=FALSE, message=FALSE, collapse=FALSE}

  DT.25.NoCx[, .(Day,Subject,logBF) ]

```

------------------------------------------------------------------------

# **Results Section 2.** Place field alignment to spatial geometry persists over days and predicts digging behavior

## **Figure 2. Place field alignment to spatial geometry persists over days.**

------------------------------------------------------------------------

> **Figure 2.** Place field alignment to spatial geometry persists over days. A) Example place cell maps from two simultaneously recorded cells on day 3 from electrophysiology (left) and calcium-imaging (right) recordings. B) Quantification of best match rotation (BMR) between trials for a cell. Place cells' maps are compressed to squares (indicated by the dashed lines and arrow on top of each map) and compared across all trials to determine which rotation yields the highest correlation between each pair of maps. For each trial comparison, one of the maps is rotated 0°, 90°, 180°, and 270°. The highest pixel to pixel cross-correlation between the non-rotated trial A map and rotated trial B map determines the BMR for that trial comparison. C) Distribution of best-match rotations across days using electrophysiological (N = 7 on day 1 and 6 on days 2 and 3, left) and calcium-imaging (N = 5, right) recordings, computed as the proportion of pairwise trial comparisons for which each rotation yielded the best match, averaged per animal. D) Schematic of heading prediction method using the center-out measure (see methods). For each place field, the angles from the center of the arena to the center of mass of the field was measured. The center-out measure from Corr (C, teal) and Geo (G, red) trials were used to train a Support Vector Machine (SVM), leaving the trial to be predicted out (gray). E) Heading prediction accuracy using center-out measure. Histograms represent mean  standard error of the mean (SEM), circles represent individual animal points. Red dashed line represents chance level (50%). Asterisks (\*) indicate p ≤ 0.05.

------------------------------------------------------------------------

### Fig.2C-left) Distribution of bestmatch rotations across days using electrophysiological recordings

{Design (3 Day x S) x (4 Rotaton x S)}

![Figure 2C-Left (see `Grp.2CL` code to generate this image)](images/Fig2CLeft.png){width="400"}

```{r F2C-L, warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig2")
  Mk.dir(NmRoo)
   
  #DT3 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/Tetrodes.RDS")))
  DTp<-copy(Tetrodes)
  
  # "Fig.2CLeft) Box Plot
    ColPer=c("#D599D7", "#AA33B0","#700075")
    Grp.2CL<- Grph.2023(
      DatP = DTp,
        Dvp="Proportion", VarX="Rotation",VarFill="Day",
        LblsP =c("Cluster Quality", "","Percent Trial Pairs","Best Match Rotation"),
        ylmP =c(0,.6),hLin = F,lvIp = 4,GrpSel = c(1:3),wMain=F,
      TyGrp="Box", # Bar, Box, Violin, SplitViolin
      Wthdot=T, Relleno=T, ResumAd=T,ColPer=ColPer
    )
    ggsave(paste0(NmRoo,"/Fig2C_Left.pdf"), Grp.2CL, width=10, height=10)
  
# Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Proportion', by=.(Rotation,Day)]
  #DTRes<-DTp[,c(N = .N,as.list(summary(Proportion))), by=.(Rotation,Day)]
  write.csv2(DTRes,paste0(NmRoo, "/Tetrodes_Descriptive.csv"))
 
# AOV
  a0 <- aov_ez("Subject", "Proportion", DTp,
        within = c("Rotation","Day"))
  
  # Effect size & Mixed
  eef<-effectsize::eta_squared(a0, generalized=TRUE)
  Mod.1r<-lmer(Proportion~Day * Rotation + (1|Subject),data=DTp)
      
# Pos Hoc
  # Defines orthogonal contrasts from a prioristic perspective
  custom <- list(`0.180vs90.270` = c(1,-1, 1,-1),
                       `0vs180` =  c(1, 0,-1, 0),
                      `90vs270` =  c(0, 1, 0,-1)
                   )
                 
  PosH.4w = PosHocAut(Mod.1r, Mod.1r, "Rotation", c("Rotation","emmean"), custom=custom)
  Grp<-"Run Grp.2CL code"
  # Grp.2CL
  <<ResCtrl1>> 
```

### Fig.2C-right) Distribution of bestmatch rotations across days using calcium-imaging recordings

{Design (3 Day x S) x (4 Rotaton x S)}

![Figure 2C-Rght (see `Grp.2CR` code to generate this image)](images/Fig2CRight.png){width="400"}

```{r Fig2C-R, warning=FALSE, message=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig2")
  Mk.dir(NmRoo)
  
  #DT4 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalciumNormal.RDS")))
  DTp<-copy(CalciumNormal)
  
  # Fig.2CRight) Box Plot
    ColPer=c("#D599D7", "#AA33B0","#700075")
    Grp.2CR<- Grph.2023(
      DatP = DTp,
        Dvp="Proportion", VarX="Rotation",VarFill="Day",
        LblsP =c("Cluster Quality", "","Percent Trial Pairs","Best Match Rotation"),
        ylmP =c(0,.6),hLin = F,lvIp = 4,GrpSel = c(1:3),wMain=F,
      TyGrp="Box", # Bar, Box, Violin, SplitViolin
      Wthdot=T, Relleno=T, ResumAd=T,ColPer=ColPer
    )
    ggsave(paste0(NmRoo,"/Fig2C_Right.pdf"), Grp.2CR, width=10, height=10)
  
# Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Proportion', by=.(Rotation,Day)]
  #DTRes<-DTp[,c(N = .N,as.list(summary(Proportion))), by=.(Rotation,Day)]
  write.csv2(DTRes,paste0(NmRoo, "/CalciumNormal_Descriptive.csv"))
 
# AOV
  a0 <- aov_ez("Subject", "Proportion", DTp,
        within = c("Rotation","Day"))
  
  # Effect size & Mixed
  eef<-effectsize::eta_squared(a0, generalized=TRUE)
  Mod.1r<-lmer(Proportion~Day * Rotation + (1|Subject),data=DTp)
  
# Pos Hoc
  # Defines orthogonal contrasts from a prioristic perspective
  custom <- list(`0.180vs90.270` = c(1,-1, 1,-1),
                       `0vs180` =  c(1, 0,-1, 0),
                      `90vs270` =  c(0, 1, 0,-1)
                   )
                 
  PosH.4w = PosHocAut(Mod.1r, Mod.1r, "Rotation", c("Rotation","emmean"), custom=custom)
  Grp <- "Run Grp.2CR code"
  # Grp.2CR
  <<ResCtrl1>> 
```

# **Results Section 3.** Different CA1 cells display distinct context sensitivity

## **Figure 3. Different CA1 cells display distinct context sensitivity.**

------------------------------------------------------------------------

> **Figure 3.** Different CA1 cells display distinct context sensitivity. A) Possibilities of neural representations of context recognition. In possibility 1 (left panel) cells align to geometry within each context but display location remapping across context. In possibility 2 (right panel) some cells display identical alignment in both contexts, showing insensitivity to the featural information that distinguish the chambers, while another group of cells show distinct geometric alignment within each chamber but display location remapping across contexts. B) Schematic of map alignment procedure. Since place fields in disoriented animals align to the geometry of the chamber, each cells' maps are first aligned to the same orientation across trials by selecting the rotation (0° or 180°) of each map that yielded the maximal similarity within each context. Then, an average map of each aligned context is calculated, and the average maps are aligned relative to each other. The comparison that yields the highest correlation is defined as the measure of context similarity. In the schematic, the transparent rotated map shows the lowest similarity score and, therefore, the non-rotated map is selected for alignment. C) Distribution of context similarity scores across context for all cells (n = 2669). The distribution shows a strong leftward skewness, indicating that although spatial maps are highly similar across contexts for most place cells, a moderate proportion of cells remap across contexts (e.g., cells exhibit shifts in their preferred firing locations). A cut-off value of 0.3 was used to separate cells based on context similarity. This value was validated by dividing the context similarity distribution in deciles and evaluating mean correlation corresponding to each decile using a modeling approach (Figure S4). Cells with context similarity equal or below 0.3 were defined as Feature-Sensitive (FS) and cells with context similarity above 0.3 were defined as Feature-Insensitive (FI). D) Proportion of FI and FS cells recorded on day 1 (n = 925), day 2 (n = 915 cells), and day 3 (n = 829). E) Examples of average aligned maps of FI (left) and FS (right) cells from electrophysiology (top) and calcium-imaging (bottom) recordings, along with the corresponding context similarity measures. FI cells show an average context similarity of 0.654 ± 0.003 and FS cells show an average context similarity of 0.160 ± 0.006 (M ± SEM).

> **Figure S4.** Complement of Figure 3. Validation of remapping threshold. A. Scatterplots showing average correlations within and across context for individual cells separated in deciles obtained from the similarity distribution shown in Figure 3C. B. Asymptotic regression model of the overall correlation decile function. The red dot indicates the half life of the function, which coincides with decile 1 (correlations across context between 0 and 0.3) and the root of the function (value that makes the function 0 on the y axis). Finally, in the asymptotic regression model, the relative growth rate is not constant. It attains its peak when Y = 0 and diminishes as Y increases. This suggests that Decile 1, corresponding to Y = 0, represents the point at which the rate of change is maximized. This indicates that that the first decile is the most informative to discriminate across context (Modeling method detailed in the next page).

------------------------------------------------------------------------

### Fig.3C) Distribution of context similarity scores across context for all cells

![Figure 3C (see `F3C` code chunk to generate this image)](images/Fig3C.png){width="600"}

```{r F3C, out.width="800px",out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig3")
  Mk.dir(NmRoo)
  
  #DT5 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalcTetrodePairwiseCorr.RDS")))
  DTp<-copy(CalcTetrodePairwiseCorr)
  
  pdf(paste0(NmRoo,"/Fig3C.pdf"),width = 12,height = 6)
        hist(DTp$bestAlignedCorrelation,breaks = 60,freq = F,col = "dodgerblue",xlab="Context Similariry",main="")
        abline(v=.3,lty=2,col="red",lwd=3)
        rect(-.2,0,.3,2.1,col=rgb(1,0,0,alpha=0.3))
        rect(.3,0,1,2.1,col=rgb(0,0,1,alpha=0.3))
        text(.29,2,"FS")
        text(.31,2,"FI")
  dev.off()
  
  # Alternative method with ggplot
  #GrpCorr<-ggplot(DTp, aes(x=bestAlignedCorrelation, after_stat(density))) + 
  #  geom_histogram(bins=60,color="black", fill="dodgerblue") + 
  #  geom_vline(aes(xintercept=.3), color="red", linetype="dashed", size=3) +theme_bw_MM()
  
  cat("For Figure 3C, run the following code lines of hist\n")
    # hist(DTp$bestAlignedCorrelation,breaks = 60,freq = F,col = "dodgerblue",
    #      xlab="Context Similariry",main="")
    #       abline(v=.3,lty=2,col="red",lwd=3)
    #       rect(-.2,0,.3,2.1,col=rgb(1,0,0,alpha=0.3))
    #       rect(.3,0,1,2.1,col=rgb(0,0,1,alpha=0.3))
    #       text(.25,2,"FS")
    #       text(.35,2,"FI")
```

### Fig.3D) Proportion of FI and FS cells recorded across days

Given the simplicity of this graph, only the numerical values of the graph are provided.

```{r F3D, collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  DTp2<- copy(CalcTetrodePairwiseCorr) %>%
  .[,CellType:= sapply(bestAlignedCorrelation,function(x) if(x<=.3) 'FS' else "FI")] %>%
  .[,data.table(table(CellType)), by=Day] %>%
  .[,Perc:=percent(N/sum(N)), by=Day] %>%
    data.table()
  DTp2
```

## Fig.S5. Validation of remapping threshold

> **Figure S5.** Complement of Figure 3. Validation of remapping threshold. A. Scatterplots showing average correlations within and across context for individual cells separated in deciles obtained from the similarity distribution shown in Figure 3C. B. Asymptotic regression model of the overall correlation decile function. The red dot indicates the half life of the function, which coincides with decile 1 (correlations across context between 0 and 0.3) and the root of the function (value that makes the function 0 on the y axis). Finally, in the asymptotic regression model, the relative growth rate is not constant. It attains its peak when Y = 0 and diminishes as Y increases. This suggests that Decile 1, corresponding to Y = 0, represents the point at which the rate of change is maximized. This indicates that that the first decile is the most informative to discriminate across context (Modeling method detailed in the next page).

### Fig.S5A) Validation of remapping threshold. Scatterplots showing average correlations within and across context

![Figure S5A (see `Grp.S5A` code to generate this image)](images/FigS5A.png){width="600"}

```{r FS5A, out.width="1000px",out.height="600px", collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig3")
  Mk.dir(NmRoo)
  
  #DT5 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalcTetrodePairwiseCorr.RDS")))
  DTp<-copy(CalcTetrodePairwiseCorr)
  
  # Correlation Bt-Wit
  Efs<-DTp[,cor(avgWithinCorrelation,avgAcrossCorrelation),by=.(Decile)]
  setkey(Efs,Decile)
  names(Efs)<-c("X", "Y")
  cat("Within and across context correlation:\n");
    Efs
  cat("---------------------\n");
  
  Decil.Labs <- c( "1"= "Decile 1 (.00 < bestCorr <= .30",
                  "2"= "Decile 2 (.30 < bestCorr <= .42",
                  "3"= "Decile 3 (.42 < bestCorr <= .51",
                  "4"= "Decile 4 (.51 < bestCorr <= .58",
                  "5"= "Decile 5 (.58 < bestCorr <= .64",
                  "6"= "Decile 6 (.64 < bestCorr <= .69",
                  "7"= "Decile 7 (.69 < bestCorr <= .75",
                  "8"= "Decile 8 (.75 < bestCorr <= .80",
                  "9"= "Decile 9 (.80 < bestCorr <= .86",
                  "10"= "Decile 10 (.86 < bestCorr <= 1.00"
                  )
  Decil_labeller <- function(variable,value){return(Decil.Labs[value])}
  
  forLab<-data.frame(Decile=Efs$X,avgWithinCorrelation=.1,avgAcrossCorrelation=.9,Label=paste("R = ",round(Efs$Y,2)))
  Grp.S5A<-ggplot2::ggplot(data=DTp, aes(x=avgWithinCorrelation, y=avgAcrossCorrelation, color=factor(Decile)))
  Grp.S5A<- Grp.S5A + scale_color_manual(values=decilecolors) + geom_point() + facet_wrap(~Decile, nrow=2, 
                                      labeller = labeller(Decile=Decil.Labs)) + theme_bw_MM() + 
    theme(legend.position="none") + geom_smooth(method = "lm", se = FALSE,col="gray40") +
     labs(x="Average Pair-wise Within Correlation", y="Average Pair-wise Across Correlation") +
    geom_text(data = forLab, mapping = aes(label = Label), col="black")
 
  ggsave(paste0(NmRoo,"/FigS5A.pdf"), Grp.S5A, width=12, height=6)
  
  cat("Run Grp.S5A code for Fig. S5A:\n")
  # To view Figure S5A:
  # Grp.S5A
```

### Fig.S5B) Validation of remapping threshold. Asymptotic regression model of the overall correlation decile function

The Asymptotic Regression model (hereinafter AsymReg) is used to model a response y that approaches a horizontal asymptote as x tend to infinity (see Original article: [Stevens, W. L., 1951, Asymptotic Regression. *Biometrics*, *7*(3), 247--267. https://doi.org/10.2307/3001809](https://doi.org/10.2307/3001809)), also known as the Mitscherlich law in agriculture and as the von Bertalanffy law in fisheries research or Monomolecular Growth.\
We are going to focus on the model as defined in the `SSasymp` function of the R'nls library (see pages 511-512 on [Pinheiro, J.C. and Bates, D.M., 2000, Mixed-effects models in S and Splus. Springer](https://github.com/ManuMi68/MuLaNa2/blob/main/NeuroSpatialData/AppendixPinheiroBates2000.pdf): `Asymreg1<-formula(Y~Asym+(R0-Asym)*exp(-exp(lrc)*X))`.\
The model parameters are:

-   `Asym` 𝜙~1~: The horizontal asymptote on the right side (very large values of `input`).

-   `R0` 𝜙~2~: The response when `input` is zero.

-   `R0` 𝜙~3~: The natural logarithm of the rate constant.

We have created the function, [`AdjMod.23.f`](https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/AdjAsymReg.R), to systematize all computations related to the AsymReg Model.

![Figure S5B (see `AdjMod.23.f` code to generate this image)](images/FigS5B.png){width="400"}

```{r FS5B, collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig3")
  Mk.dir(NmRoo)
  
  #DT5 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalcTetrodePairwiseCorr.RDS")))
  DTp<-copy(CalcTetrodePairwiseCorr)
  
  # Correlation Bt-Wit
  Efs<-DTp[,cor(avgWithinCorrelation,avgAcrossCorrelation),by=.(Decile)]
  setkey(Efs,Decile)
  names(Efs)<-c("X", "Y")
  
  # Base model
  fit <- NULL
  try(fit <- nls(Y ~ SSasymp(X, Asym, R0, lrc), data=Efs, trace = TRUE,control = list(maxiter = 500)))
  
  # Eq0 is the fundamental equation of the model, verified, from which all the rest is derived
  Eq0.a=quote(response)
  Eq0.b=quote(Asym+(R0-Asym)*exp(-exp(lrc)*input))
  Eq0=substitute(a ~ b , list(a = Eq0.a, b = Eq0.b))
  Eq0= as.expression(Eq0)
  EqTheta = ChangeSymbAR(EqQuo = Eq0,SymRes = c("theta[1]", "theta[2]", "theta[3]"))
  EqCDR = ChangeSymbAR(Eq0,letters[seq(1, 3)],c("Asym","R0","exp(lrc)"))
  EqTheta2 = ChangeSymbAR(EqQuo = Eq0,SymRes = c("Asymptote", "Origin", "LogRate"),LaX = "Decile",LaY="Correlation")
  EqTt.1=quote({"Asymptotic Regression:"})
  Eq.1=quote({f[theta](x) == theta[1] + (theta[2]-theta[1])*~e^{-e^{theta[3]}*~x}})
  EqLb.1=substitute(a ~ b , list(a = EqTt.1, b = Eq.1))
  EqTt.2=quote({"First derivative:"})
  Eq.2=quote({f*" '"[theta](x) == {e^{theta[3]}*~(theta[1]-f[theta](x))}})
  EqLb.2=substitute(a ~ b , list(a = EqTt.2, b = Eq.2))
  EqTt.3=quote({"Params:"})
  Eq.3=quote(list(theta[1] == "Asymptote", theta[2] == "Origin", theta[3] == "Log of Rate")~"["*{Rate==e^{theta[3]}}*"]")
  EqLb.3=substitute(a ~ b , list(a = EqTt.3, b = Eq.3))
  JnEq=list(EqLb.1,EqLb.2,EqLb.3)
 
  cat("Asymptotic regression model of the overall correlation decile function:\n")
  RsM1<-AdjMod.23.f(LasMedP=Efs, TyLbl=JnEq, xLb="Decile",yLb="Pearson's Correlation", xmaxp=10,yminp=-1)
  pdf(paste0(NmRoo,"/FigS4B Suppl Graph AsymReg.pdf"),width = 6,height = 6)
        AdjMod.23.f(LasMedP=Efs, TyLbl=JnEq, xLb="Decile",yLb="Pearson's Correlation", xmaxp=10,yminp=-1)
  dev.off()
  
  cat("Table S4: Details of model fit Asymptotic regression:\n" )
  RsM1$forAPA2
  MkKblMod(RsM1,NmRoo,"",EqTheta2)
  cat("Half-life stimation from Asymptotic Regression (xMed=log(2)/(exp(lrcStim)):\n" )
  RsM1$Par
  cat("Root Value from Taylor Polynomial:\n" )
  RsM1$root
 
  
```

#### Fig.S5B) The relative growth rate in the Asymptotic regression model

Due to its biological meaning, the most widespread parameterisation of AsymReg is:\
Y=a−(a−b)exp(−cX) where a is the maximum attainable Y, b is Y at x=0\
and c is proportional to the relative rate of Y increase while X increases.\
Indeed, we can see that the first derivative is\
\[D(expression(a - (a - b) \* exp (- c \* X)), "X")\]:\
(a - b) \* (exp(-c \* X) \* c); that is\
Y′=c(a−Y)

This conclusion is demonstrated as follows:\
Y = Asym + (R0 - Asym) \* exp(-exp(lrc) \* X)\
Y'= -((R0 - Asym) \* (exp(-exp(lrc) \* X) \* exp(lrc)))\
c = exp(lrc)\
- Y = Asym + `(R0 - Asym) * exp(-c * X)` = Asym + D\
- D = Y - Asym\
- Y' = -((R0 - Asym) \* (exp(-c \* X) \* c ))\
- Y' = (-1)\* (R0 - Asym) \* exp(-c \* X) \* c\
- Y'/-c = (R0 - Asym) \* exp(-c \* X)\
- Y'/-c = Y - Asym\
- Y' = -c \* (Y-Asym) = c \* (Asym - Y)\
- Proved: Y′=c(a−Y); taking into account that `a` refers to `Asym` (the Asymptote or plateau).

The first derivative of a function gives the expression for the line tangent to the curve of the function. This expression allows us to find the instantaneous rate of change at any point on the curve.

**We will now show that the relative growth rate in the asymptotic regression model (first derivative) is not constant, reaching its maximum value when Y = 0 and decreasing as Y increases.**\*

That is, the absolute ratio of increase of Y at a given X is not constant, but depends on the attained value of Y:\
![](images/EqFigS4Ba.png){width="125"}

And, for the relative rate of increase of Y, we see that:

![](images/EqFigS4Bb.png){width="125"}

It means that the relative rate of increase of Y is maximum at the beginning and approaches 0 when Y approaches the Asymptote `a`.

```{r, results='asis', fig.show='asis', collapse=FALSE, fig.keep = 'low', fig.cap= c("Values predicted by the AsymReg model...", "Adding the relative growth rate on Decile 1...", "Adding the relative growth rate for the rest of Deciles...")}

  cat("1)  In the first place we extract the parameters, and other values of interest, of the AsymReg model from the variable **fit**\n")
  XMax=tail(Efs$X,1)
  xPred <- seq(0, XMax, length = 1000);
  theta1=a=Asymptote= Asym=AsymStim=coefficients(fit)[[1]]
  theta2=b=Origin=    R0=R0Stim=coefficients(fit)[[2]]
  theta3=LogRate=     lrc=lrcStim=coefficients(fit)[[3]]
  xMed=log(2)/(exp(lrcStim))
  PredxMed=predict(fit, data.frame(X = xMed))
  Rate=c=             exp(lrcStim)
  
  cat(c(paste0("theta1 = ",theta1,"; "),
        paste0("theta2 = ",theta2,"; "),
        paste0("theta3 = ",theta3,"; "),
        paste0("Half-life = ",xMed,"; "),
        paste0("Rate = ",Rate,"\n")
        ));
  
  cat("2) Now, we represent the values predicted by the AsymReg model\n")
  PredMod=predict(fit, data.frame(X = xPred))
  plot(xPred, PredMod,lty=1,lwd=3,type="l",xlab="x: Decile", ylab="y: Pearson's Correlation")  
  
  
  cat("3) We get the relative growth rate in the AsymReg Model\n
      from the first derivative (`DrvAsymReg` function), estimate for the Decile 1 value.\n
      and plot them on a graph\n")
  newx <- 1
    pred0 <- data.frame(x=newx, y=AsymRegMM(newx,AsymStim,R0Stim,c))
    pred1 <- data.frame(x=newx, y=DrvAsymReg(newx,AsymStim,R0Stim,c))
    yint <- pred0$y - (pred1$y*newx)
    xint <- -yint/pred1$y
    lines(xPred, yint + pred1$y*xPred, lty=2,lwd=2, col="red") # tangent (1st deriv. of spline at newx)

    
  cat("4) We repeat these rate estimates for the rest of the Deciles (from 2 to 10)\n
      and incorporate these estimates in the graph\n")
  for (newx in 2:10)  {
        pred0 <- data.frame(x=newx, y=AsymRegMM(newx,AsymStim,R0Stim,c))
        pred1 <- data.frame(x=newx, y=DrvAsymReg(newx,AsymStim,R0Stim,c))
        yint <- pred0$y - (pred1$y*newx)
        xint <- -yint/pred1$y
        lines(xPred, yint + pred1$y*xPred, lty=2,lwd=1) # tangent (1st deriv. of spline at newx)
        }
```

It can be seen that the straight line with the point at which the rate of change is maximized (red color) is that which corresponds to the Decile 1, when Correlation (Y axis) = 0.

### Fig.S9) Properties of FI and FS cells

{Design 2 CellTye x 3 Day}

> **Figure S9.** Complement of Figure 3. Properties of FI and FS cells. Spatial information content of FS and FI cells. To determine if FS and FI displayed the same spatial quality a robust 2-way ANOVA was conducted on the spatial information content, with day of testing (day 1 to 3) and Cell type (FI and FS) as between' factors. Results revealed a main effect of day \[Fw(2) = 15.57, p = 0.001, 𝛏 =0.17\], as well as an interaction between day and stability \[Fw(2) = 6.56, p = 0.044, 𝛏 =0.17\], but no effect of Cell Type \[F\<1\]. Post hoc analyses using Robust Rom's multiple comparisons showed a difference in FI cells between days 1 and 2 \[p \< .001; 𝛏 =0.26\] and days 1 and 3 \[p \< .001 𝛏 =0.19\], but not between days 2 and 3 \[p\>.05; 𝛏 =0.08\]. For FS cells, there were no differences across days (p\>.05). Importantly, there were no differences between FI and FS on any testing day (p\>.05). Spatial information from calcium traces was calculated using the method developed for calcium traces by Climer and Dombeck, 2021, based on Skaggs et al., 1993. Spatial information was calculated using the following formula:
>
> ![](images/EqFigS9.png){width="125"}
>
> Where f is the mean change in fluorescence, fi is the mean change in fluorescence in a bin, pX(xi) is the probability that the animal is in the ith spatial bin during a time sample. For each cell, we made 2 matrices of binned data, one for the probability of the animal position, p\[x,y\], and one for the binned calcium trace, f \[x,y\]. Both maps were smoothed. We then computed the equation shown above, which gave one spatial information value per cell.
>
> References: Climer, J.R., Dombeck, D.A. Information theoretic approaches to deciphering the neural code with functional fluorescence imaging, eNeuro.0266-21.2021. Skaggs WE, McNaughton BL, Gothard KM (1993) An information theoretic approach to deciphering the hippocampal code 1030--1037. In: Advances in neural information processing systems 5, Hanson SJ, Cowan JD, Giles CL, eds). Burlington: Morgan-Kaufmann.

![Figure S9 (see `Grp.S9` code to generate this image)](images/FigS9.png){width="400"}

```{r FS9, warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig3")
  Mk.dir(NmRoo)
  
  #DT6 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/SpatialInformationContent.RDS")))
  DTp<-copy(SpatialInformationContent)
  
  # Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Perc', by=.(Day,CellType)]
  write.csv2(DTRes,paste0(NmRoo, "/SpatialInformationContent_Descriptive.csv"))
  
  # "Fig.S9) Box Plot
    ColPer=c("#838BC5","coral3")
    Grp.S9<- Grph.2023b(
      DatP = DTp,
      Dvp="Perc", VarX="Day", VarFill="CellType",
      LblsP =c("Cluster Quality", "","Spatial Information Content (bits/sec)",""),
      ylmP =c(0,100),hLin = F,lvIp = 4,GrpSel = c(1:3),wMain=F,
      TyGrp="Box", # Bar, Box, Violin, SplitViolin
      Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
    )
    ggsave(paste0(NmRoo,"/FigS9.pdf"), Grp.S9, width=10, height=10)
  
  # Data structure as lists for Wilcox functions
  IdSj="Subject";wv1="CellType";wv2="Day";LaVd="Perc"
  DTp2 <- copy(DTp) %>% 
    dplyr::rename(x1=all_of(wv1)) %>% 
    dplyr::rename(x2=all_of(wv2)) %>%
    dplyr::rename(y=all_of(LaVd)) %>%
    mutate(x1=factor(x1)) %>%
    mutate(x2=factor(x2)) %>%
    mutate(Inter:=factor(interaction(x1,x2))) %>%
    setkey(.,Inter)
  NumL=length(levels(DTp2$Inter)); vector=c(1:NumL)
  lv1=length(levels(DTp2$x1));lv2=length(levels(DTp2$x2))
  ArP=lapply(1:NumL, function (x) DTp2[.(levels(DTp2$Inter)[x]),"y",with=F][[1]])
  
  # t2way'Wilcox Robust ANOVA: 
  A=lv2;B=lv1;Prc=2 #A=3;B=2
  RsRb<-t2way(A,B,ArP)
  
  # Approximation to estimate Robust Effect Size  
  TamA=round(mean(ESmainMCP(A,B,ArP)$Factor.A[,3]),Prc)
	TamB=round(mean(ESmainMCP(A,B,ArP)$Factor.B[,3]),Prc)
	TamInt=round(mean(esImcp(A,B,ArP)$Effect.Sizes),Prc)
  TamJn <- c(TamA,TamB,TamInt)
  
  a0<-data.table(Names=c("Day","CellType","Day*CellType"),
                       data.table(Q=with(RsRb, round(c(Qa, Qb, Qab),Prc)),
                                  p=with(RsRb, round(c(A.p.value, B.p.value,AB.p.value),4)),
                                  EffSize=TamJn,
                                  Size= unlist(lapply(TamJn, InterpExplana))))
  #cat("Robust ANOVA:\n")
  #ExFinAOV
  
  # Pos Hoc Simple effect (with Wilcox'yuenv2, and Rom vs BH Pos Hoc)
  # Direction Day on each TypeCell
    cnt=0; yd<-list();LapAd<-NULL;LapAd2<-NULL
    PosH.4w<-list()
    for (i2 in 1:lv1) {
      LaP=NULL
      for (i in (1:(lv2-1))) {
      for (j in ((i+1):(lv2))) {
        cnt=cnt+1
        sample1<-DTp[Day==levels(DTp$Day)[i]&CellType==levels(DTp$CellType)[i2],Perc] 
        sample2<-DTp[Day==levels(DTp$Day)[j]&CellType==levels(DTp$CellType)[i2],Perc] 
        out=c(unlist(yuenv2(sample1,sample2)))
        yd[[cnt]]<-as.data.table(rbind(out))
        LaP=c(LaP,yd[[cnt]]$p.value)
        yd[[cnt]]<-data.table(cbind(IV1=levels(DTp$CellType)[i2],
                                    IV2.a=levels(DTp$Day)[i],IV2.b=levels(DTp$Day)[j],yd[[cnt]]))
      }
      }
      LapAd2<-c(LapAd2,p.adjust(LaP, "BH")) # Optim
      LapAd<-c(LapAd,adjustRom(LaP))
    }
  
    ext1<-ExtrSig(LapAd); names(ext1)<-c("p.Rom","Sig.Rom")
    ext2<-ExtrSig(LapAd2); names(ext2)<-c("p.BH","Sig.BH")
    ResPosRob2<-data.table(do.call("rbind", yd),ext1,ext2)
    ResPosRob2$p.value=frmMM( ResPosRob2$p.value,4)
    for (i in (c(4,5,9:15)))ResPosRob2[[i]]<-as.numeric(frmMM(ResPosRob2[[i]],2))
    ResPosRob2<-data.table(ResPosRob2, Tam= unlist(lapply(ResPosRob2$Effect.Size, InterpExplana)))
    setorder(ResPosRob2, -Sig.BH)
    ResAPA<-lapply(1:nrow(ResPosRob2), function(i) with (ResPosRob2[i,], paste0(IV1,": ",IV2.a," - ",IV2.b," = ",dif,": ","tw(",df,") = ",
                                   teststat, "; pROM = ", p.Rom, "; \U1D6CF =",
                                   Effect.Size, " (",Tam," effect)")))
    
    # Results
    PosH.4w$PosHocMM <- unlist(ResAPA)
    PosH.4w$Means <- ResPosRob2
    
    #cat("Robust Pos Hoc Simple Effect of Day on each CellType:\n")
    # More details on ResPosRob2
    #unlist(ResAPA)
    Grp<-"Run Grp.S9 code"
    # Grp.S9
    <<ResCtrl1>>  
```

### Fig.S10), S11) and Table S5)

{design (2 Context x S) x (4 Rotation x S) x 2 CellType x 2 Day}

> **Figure S10.** Complement of Figure 3. FI and FS cells display similar geometric alignment within context. A-F) Although our analysis of map similarity across context indicated that FS cells displayed feature-sensitive remapping, we observed that when analyzed as a group, without distinguishing between FS and FI, the population of active cells aligned to geometry (Figure 2C-D). This result could happen if both FS and FI cell align to geometry within context despite having different phenotypes across context. To investigate this possibility, we evaluated the alignment of FS and FI within each context by conducting the best match rotation analysis depicted in Figure 2A, but this time broken down by chamber. This analysis was performed on the calcium imaging data to have sufficient data points for FS cells. A 4- way repeated measures ANOVA with Context (A or B) and Rotation (0°, 90°, 180°, 270°) as within cells' factors, and cell type (FI or FS) and day (days 1-3) as between factors showed both FI and FS cells displayed geometric alignment within each context. There was a significant main effect of rotation \[F(2.89, 5827.38) = 78.27, p \< .001. Additionally, there was a significant interaction between Day, Context and Rotation \[F(5.83, 5884.64) = 2.86, p \< .001; the complete results of this ANOVA are shown in Table S5\]. In agreement with our hypothesis, post hoc Rom's tests showed that the best match rotations at 0° and 180° occurred more often than other rotations in both Context A and Context B (p\< .05 on days 1 and 3). Even though geometric alignment persisted throughout training, on day 3 both FS and FI cells also showed higher proportion of best match rotations at 0° than 180º in both contexts (p\< .05), paralleling the increase in number of correct digs.

![Figure S10 (see `Grp.S10` code to generate this image)](images/FigS10.png){width="400"}

```{r FS10, warning=FALSE, message=FALSE, out.width="1000px", out.height="800px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig3")
  Mk.dir(NmRoo)
  
  #DT7 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalciumStabilityPerCell.RDS")))
  DTp<-copy(CalciumStabilityPerCell)
  
  # "Fig.S8) Bar Plot  
    ColPer=c("#65C8D0","#838BC5")
    Grp.S10<- Grph.2023(
      DatP = DTp,
      Dvp="Proportion", VarX="Rotation", VarFill="Context",
      LblsP =c("Cluster Quality", "","Percent",""),
      ylmP =c(0,50),hLin = F,lvIp = 24,GrpSel = c(1:2),wMain=F,
      TyGrp="Bar", # Bar, Box, Violin, SplitViolin
      Wthdot=F, Relleno=T, ResumAd=F,ColPer=ColPer
    )
    Grp.S10 <- Grp.S10 + facet_grid(Day ~ CellType)
    ggsave(paste0(NmRoo,"/FigS8.pdf"), Grp.S10 ,width = 12,height = 10)
    
  # Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Proportion', by=.(Rotation,CellType,Context,Day)]
  #DTRes<-DTp[,c(N = .N,as.list(summary(Proportion))), by=.(Axis,Day,Context)]
  write.csv2(DTRes,paste0(NmRoo, "/CalciumStabilityPerCel_Descriptive.csv"))
  
  #AOV
  a0<-NA
  a0 <- aov_ez("CellName", "Proportion", DTp, between = c("CellType","Day"), 
       within = c("Context","Rotation"))
    
  
  # Effect size & Mixed
  eef<-effectsize::eta_squared(a0, generalized=TRUE)
  Mod.1r<-lmer(Proportion~ CellType * Day * Context * Rotation + (1|CellName),data=DTp)
  
  # Pos Hoc of the more complex significant effect: Day:Context:Rotation
  # Defines orthogonal contrasts from a prioristic perspective
    custom <- list(`0y180sup` = c(1,-1,1,-1),
                     `0vs180` = c(1,0,-1,0),
                    `90vs270` = c(0,1,0,-1)
                 )
    
    PosH.4w = PosHocAut(a0, Mod.1r, "Rotation|Day|Context", c("Context","Day","emmean"), custom)
    
    # Since it is analyzed only at the level of the Day:Context:Rotation interaction, 
     #it would be of interest to obtain the descriptive statistics for this simple single effects approach. 
    DTRes2<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Proportion', by=.(Rotation,Context,Day)]
    write.csv2(DTRes2,paste0(NmRoo, "/CalciumStabilityPerCel_Descriptive2.csv"))
    
    Grp<-"Run Grp.S10 code"
    # Grp.S10
    <<ResCtrl1>>
    
```

> **Figure S11.** Complement of Figure 3. Same data shown in Figure S8 plotted as boxplots with overlaid violin plots to depict variability in detail.

![Figure S11 (see `Grp.S11` code to generate this image)](images/FigS11.png){width="400"}

```{r FS11, warning=FALSE, message=FALSE, out.width="1000px", out.height="800px", collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig3")
  Mk.dir(NmRoo)
  DTp<-copy(CalciumStabilityPerCell)
  Grp.S11<- Grph.2023(
    DatP = DTp,
    Dvp="Proportion", VarX="Rotation", VarFill="Context",
    LblsP =c("Cluster Quality", "","Percent",""),
    ylmP =NULL,hLin = F,lvIp = 24,GrpSel = c(1:2),wMain=F,
    TyGrp="SplitViolin", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )
  Grp.S11 <- Grp.S11 + facet_grid(Day ~ CellType)
  ggsave(paste0(NmRoo,"/FigS11.pdf"), Grp.S11 ,width = 12,height = 10)
  cat("Run Grp.S11 code for Figure S11\n")
  # Grp.S11
```

> **Table S5.** Complement of Figure 3, S10, and S11. Statistical Table corresponding to Figures S10 and S11. To determine if there differences in FI or FS cells in the pattern of alignment in context A or B across days, we conducted a 4-way repeated measures ANOVA with Context (A or B) and Rotation (0o, 90o, 180o, 270o) as within-cells' factors, and Cell Type (Feature-Sensitive or Feature-Insensitive) and Day (Day 1 to 3) as between factors. dfNum indicates degrees of freedom numerator. dfDen indicates degrees of freedom denominator. Epsilon indicates Greenhouse-Geisser multiplier for degrees of freedom, p-values and degrees of freedom in the table incorporate this correction. SSNum indicates sum of squares numerator. SSDen indicates sum of squares denominator. h2g indicates generalized eta-squared. \* p≤ .05, \*\* p≤.01, \*\*\*p≤.001.

The 4-way ANOVA of the design of this section is the one we saw in `a0`, a little further back.\
This section serves only to convert this ANOVA to the APA format as shown in Table S5.\
You will find the result of the code of this section in the word file:\
**CalciumStabilityPerCel_ezANOVACorGG.doc**\
***Execute the following code if you want to generate the word file***

```{r TS5, warning=FALSE, message=FALSE, eval=FALSE}
    if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
    NmRoo = paste0(DirPath,"/", "Fig3")
    Mk.dir(NmRoo)
    DTp<-copy(CalciumStabilityPerCell)

    matchAll = function(x, table, nomatch=NA_integer_, incomparables=NULL) {
      which(!is.na(match(table, x, nomatch, incomparables)))
    }
    complete.cases.within = function(data, dv, wid) {
      incomplete = data %>% select(dv) %>% complete.cases() %>% !. #boolean vector containing incomplete rows
      toRemove = data %>% select(wid) %>% filter(incomplete) %>% .[,1] %>% unique() #all IDs containing incomplete rows
      positions = matchAll(toRemove, data[,wid])
      return(if (length(positions)==0) data else data[-positions,]) #drop all rows matching toRemove IDs
    }
    IntraEz = ezANOVA(data = complete.cases.within(data = data.frame(DTp),dv = 'Proportion',wid = 'CellName'), 
                  dv = Proportion,
                  wid = CellName,
                  within = .(Context,Rotation),
                  between= .(CellType,Day),
                  type=3,
                  detailed = TRUE)
    
    ezANOVAAPA <- apa.ezANOVA.table( IntraEz,
                                  filename=paste0(NmRoo,"/CalciumStabilityPerCel_ezANOVACorGG.doc"))
    ezANOVAAPA
   
```

# **Results Section 4.** FS cells display lower context similarity than FI cells and predict context across days

## **Figure 4. FS cells display lower context similarity than FI cells.**

> **Figure 4.** FS cells display lower context similarity than FI cells and predict context across days. A) Schematic illustrating dot product method for measuring population similarity across contexts. Average aligned maps recorded in Context A and B are stacked and the normalized dot product is computed between population vectors in each corresponding pixel across cells. B) Distributions of normalized dot product of population data collected from FI (solid) or FS (dotted) cells across days. Note higher dot products of FI cells in comparison to FS cells. FS cells have a lower dot product on days 2 and 3 than day 1, indicating more dissimilarity in the spatial maps at the population level across time. Asterisks represent p \< 0.01 (**) or 0.001 (**\*). C) Schematic of population vector analysis for predicting context. Average aligned maps in Context A and Context B are calculated withholding one trial at a time. The dot product is computed as described in panel A; however, averaged aligned maps were computed withholding one trial at a time, and the normalized dot product between average aligned maps and the withheld trial were compared. The predicted context corresponds to the highest average dot product. D) Average context prediction accuracy using FI cells (left panel, day 1: N = 12 mice, day 2: N = 11 mice, and day 3: N = 11 mice) or FS cells (right panel, day 1: N = 9 mice, day 2: N = 7 mice, and day 3: N = 8 mice), averaged for each animal. Only FS cells reliably predict context across days (p \< .01). Histograms represent mean ± SEM, circles represent individual data points.

### Fig.4B) Distributions of normalized dot product of population data from FI or FS cells across days

{Design 2 CellType x 3 Day} Ranked

![Figure 4B (see `Grp.4B` code to generate this image)](images/Fig4B.png){width="600"}

```{r F4B, warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig4")
  Mk.dir(NmRoo)
  
  #DT1 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/DistributionsPopulationData.RDS")))
  DTp<-copy(DistributionsPopulationData)
  
  # Fig.4B)  ECDF: Empirical Cumulative Distribution Function
     ColPer=c("#D599D7", "#AA33B0","#700075")
     Grp.4B <- ggplot(DTp, aes(Corr,color=Day,lty=CellType)) +
       stat_ecdf(geom = "step") + 
       scale_color_manual(values=ColPer) + 
       scale_linetype_manual(values=c(1,2)) +
       xlab("Normalized Dot Product") + ylab("Cumulative") +
       theme_bw(base_size = 14)
     ggsave(paste0(NmRoo,"/Fig4B.pdf"), Grp.4B, width=12, height=6)
  
  # Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Corr', by=.(CellType,Day)]
  #DTRes<-DTp[,c(N = .N,as.list(summary(Proportion))), by=.(Axis,Day,Context)]
  write.csv2(DTRes,paste0(NmRoo, "/DistributionsPopulationData_Descriptive.csv"))
  
  # Ranked AOV
  a0 <- rankFD(Corr ~ CellType * Day, data = DTp)
  
  # Effect Size
  # The most appropriate estimation would be that provided by QS, but current developments are limited to 2^k designs,
  # for which reason we could not perform the estimation in this design, since the variable Day has more than 2 levels.
  
  
  # Pos Hoc of the more complex significant effect: CellType:Day
  # For Direction Day on each CellType
  Contr<-list()
  Contr[[1]]=c((levels(DTp$Day))[1],(levels(DTp$Day)[2]))
  Contr[[2]]=c((levels(DTp$Day))[1],(levels(DTp$Day)[3]))
  Contr[[3]]=c((levels(DTp$Day))[2],(levels(DTp$Day)[3]))
 
  ResRanPH<- lapply(1:2, function(y) lapply(1:3, function(x) {
    data.table(
      TypeCell=levels(DTp$CellType)[y],
      npar.t.test(Corr ~  Day, data = DTp[(Day ==Contr[[x]][1]|Day ==Contr[[x]][2])&CellType==levels(DTp$CellType)[y]])$Analysis,
      QS=round(ESfun( DTp[Day ==Contr[[x]][1]&CellType==levels(DTp$CellType)[y]]$Corr,
                      DTp[Day ==Contr[[x]][2]&CellType==levels(DTp$CellType)[y]]$Corr,
        method = "QS"),3),
      Size= InterpEfGen(ESfun(DTp[Day ==Contr[[x]][1]&CellType==levels(DTp$CellType)[y]]$Corr,
                              DTp[Day ==Contr[[x]][2]&CellType==levels(DTp$CellType)[y]]$Corr,
        method = "QS"),c(0.55,0.64,0.71)))
    }))
  
  ResRanPH<-data.table(do.call("rbind",unlist(ResRanPH,recursive = F)))
  
  # Apply Bonferroni correction
  splir<-split(ResRanPH[,p.Value],rep(c(1:2),each=3))
  ResRanPH$p.Value<-  unsplit(lapply(splir,p.adjust,"bonferroni"),rep(c(1:2),each=3))
  
  # Results
  PosH.4w<-list(
    PosHocMM=ResRanPH[,-c(4:5,8)],
    Means =ResRanPH)
  
  a0<-a0$Wald.Type.Statistic
  Grp<-"Run Grp.4B code"
  # Grp.4B
   <<ResCtrl1>>
  
```

# **Results Section 5.** FI and FS cells display coherent patterns of alignment within and across context

> **Figure 5.** FI and FS cells display coherent patterns of alignment within and across context. A) Schematic of possible mechanisms for remapping across trials. Top example represents coherent remapping, in which all cells remap coherently between trials (e.g., each cell in this example rotates 90° counterclockwise between Context A and B). Bottom panel represents global remapping, in which cells remap incoherently (e.g., each cell displays a different rotation between Context A and B. B) Schematic of coherency analysis. BMR for all cells between a trial pair are calculated. Then, the 1st, 2nd, 3rd, and 4th BMR are calculated based on frequency of BMR. The example shown in the schematic displays the 1st (blue), 2nd (red), 3rd (yellow), and 4th (purple) BMR for 2 trial pairs, indicating the proportion of cells rotating coherently. C) Histogram of cell percentages within each BMR. Chance line (black) at 25% indicates proportion of BMRs expected from chance. Note that most of the proportions in the 1st BMR are above chance. D) Histograms showing proportion of cells within each BMR broken down by type of cell (FI and FS) and trial comparison (within or across) for day 1 (left), day 2 (center), and day 3 (right). Red line indicates chance level. Error bars denote ± 1 standard error of the mean (SEM). E) The 1st and 2nd BMRs in FI cells are consistently above chance within and across context. In FS cells, the 1st BMR increases and the 2nd BMR decreases across days. F) Coherency matrices of joint probabilities for each cell type (FI and FS) trial comparison (within and across context) for day 1 (left), day 2 (center), and day 3 (right). Rows indicate 1st BMR and columns indicate 2nd BMR. Marginal probability of 1st BMR is shown at the right of each matrix. Asterisks indicate p \< .05.

### Fig.5D) Histograms showing proportion of cells within each BMR

![Figure 5D (see `Grp.5D` code to generate this image)](images/Fig5D.png){width="400"}

```{r F5D, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}

  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig5")
  Mk.dir(NmRoo)
  
  #DT1 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalMinCorr.RDS")))
  DTp<-copy(CalMinCorr)
  
  
  TwoDT <- DTp %>%
    .[,pChi:=prop_test(N,Ntt,p=rep(.25,4),alternative = "greater")$p, by=.(Subject,Context,Day,CellType)] %>%
    .[,p.Sig:=0] %>%  .[pChi<=.10,p.Sig:=1] %>%
    mutate(BMROrder = dplyr::recode(BMROrder, "C_1" = "1st","C_2" = "2nd" ,"C_3" = "3rd", "C_4" = "4th")) %>%
    data.table() %>%
    setkey(.,Day, CellType, Context, BMROrder)
  
  
  # "Fig.5D) Bar Plot
  ColPer=c("blue","red","orange", "purple")
  Grp.5D<- Grph.2023(
    DatP = TwoDT,
    Dvp="Perc", VarX="Context", VarFill="BMROrder",
    LblsP =c("Cluster Quality", "","Proportion of Cells","Context"),
    ylmP =NULL,hLin = F,lvIp = 12,GrpSel = c(1:4),wMain=F,
    TyGrp="Bar", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=F,ColPer=ColPer
  )
  Grp.5D <- Grp.5D + facet_grid(Day ~ CellType ) + geom_hline(yintercept=0.25, color = "red")
  ggsave(paste0(NmRoo,"/Fig5D.pdf"), Grp.5D, width=6, height=12)
  
  
  cat("The values of the graph in the Figure 5D are as follows:\n")
  TwoDT[,.(Mean=round(mean(Perc,na.rm=T),3)), by=.(CellType, Context, Day, BMROrder)]
  cat("\n")
  cat("Graphics have been preloaded to avoid page overload\n");
  cat("Run Grp.5D code if you wish to view it\n")
  # Grp.5D
  
```

### Fig.5E) The 1st and 2nd BMRs in FI cells are consistently above chance within and across context

{Design 2 Context x 3 Day x (2 CellType x S) x (4 BMROrder x S)}

![Figure 5E (see `Grp.5E` code to generate this image)](images/Fig5E.png){width="400"}

```{r F5E, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig5")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalMinCorr.RDS")))
  DTp<-copy(CalMinCorr)
  
  TwoDT <- DTp %>%
    .[,pChi:=prop_test(N,Ntt,p=rep(.25,4),alternative = "greater")$p, by=.(Subject,Context,Day,CellType)] %>%
    .[,p.Sig:=0] %>%  .[pChi<=.10,p.Sig:=1] %>%
    mutate(BMROrder = dplyr::recode(BMROrder, "C_1" = "1st","C_2" = "2nd" ,"C_3" = "3rd", "C_4" = "4th")) %>%
    data.table() %>%
    setkey(.,Day, CellType, Context, BMROrder)
  
  # We select only the first and second BMR levels
  TwoDT <- TwoDT %>% .[BMROrder=="1st"|BMROrder=="2nd"]
  
  # For the graphical representation we obtain the difference with respect to the chance level
  TwoDT.Ch<- TwoDT %>% mutate(Perc=Perc-0.25) %>% 
    data.table()
  
  # "Fig.5E) Bar Plot
  ColPer=c("blue","red","orange", "purple")
  Grp.5E<- Grph.2023(
      DatP = TwoDT.Ch %>% mutate(Day=as.numeric(Day)),
      Dvp="Perc", VarX="Day", VarFill="BMROrder",
      LblsP =c("Cluster Quality", "","Proportion of cells\n(difference whith cahnce)","Day"),
      ylmP =NULL,hLin = F,lvIp = 12,GrpSel = c(1:4),wMain=F,
      TyGrp="Bar", # Bar, Box, Violin, SplitViolin
      Wthdot=F, Relleno=T, ResumAd=F,ColPer=ColPer
    )
  Grp.5E <- Grp.5E + facet_grid(CellType ~ Context) + geom_smooth(method=lm, se=FALSE, col="black") + 
    geom_hline(yintercept=0, linetype="dashed", color = "gray30")
  ggsave(paste0(NmRoo,"/Fig5E.pdf"), Grp.5E, width=6, height=12)
  
  
  # Descriptive
  DTRes<-TwoDT[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Perc', by=.(BMROrder,CellType,Context,Day)]
  write.csv2(DTRes,paste0(NmRoo, "/CalMinCorr_Descriptive.csv"))
  
  # Print Results
  # Results
    kableTabl(ezPrecis(TwoDT),"Design Structure", "")
    cat("---------------------\n");
    cat("Data Structure:\n");
      str(TwoDT) # Data File
    cat("---------------------\n");
      print(TwoDT)
    cat("---------------------\n");
      kableTabl(DTRes,"Descriptive", "")
    cat("---------------------\n");
    # cat("Graphics have been preloaded to avoid page overload\n (see the corresponding section for details).:\n");
    cat("Exploratory Analysis:\n")
    cat("Run Grp.5E code") # Exploratory Analysis
    cat("\n")
```

### Table S6) Complement of Figure 5. Best Match rotation (BMR) analysis

> **Table S6.** Complement of Figure 5.Best Match rotation (BMR) analysis: One-sample contrast with respect to the chance level. First column indicates the experimental condition from the combination of day (D1, D2, and D3, respectively for days 1 to 3), cell type (FI vs. FS), context condition (within vs. across), and BMR (C_1=1st BMR, C_2=2nd BMR). The table indicates that the 1st and 2nd BMR are significantly above chance across days and context condition, except for FS where the 2nd BMR is below chance on day 3, either within or across context. BMR 3 and 4 were below chance across days and contextual conditions for both cell types (data not shown, p\>.05).

```{r TS6, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig5")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalMinCorr.RDS")))
  DTp<-copy(CalMinCorr)
  
  Prc=2
  IdSj="Subject";wv1="Day";wv2="CellType";wv3="Context";wv4="BMROrder";LaVd="Perc"
  
  DTp2<-NA
  DTp2 <- copy(DTp ) %>% 
    mutate(Day = dplyr::recode(Day, "1" = "D1","2" = "D2" ,"3" = "D3")) %>%
    dplyr::rename(IdSuj=all_of(IdSj)) %>% 
    dplyr::rename(x1=all_of(wv1)) %>% 
    dplyr::rename(x2=all_of(wv2)) %>%
    dplyr::rename(x3=all_of(wv3)) %>%
    dplyr::rename(x4=all_of(wv4)) %>%
    dplyr::rename(y=all_of(LaVd)) %>%
    mutate_at(c("IdSuj","x1","x2","x3", "x4"), factor) %>%
    mutate(Inter:=factor(interaction(x1,x2,x3,x4))) %>%
    setkey(.,Inter)
    
  NumL=length(levels(DTp2$Inter)); vector=c(1:NumL)
  
  fff=lapply(1:NumL, function (x) unlist(D.akp.effect.ci(
    DTp2[.(levels(DTp2$Inter)[x]),"y",with=F][[1]],null.value = .25)))
  
  fff3=lapply(1:NumL, function (x) unlist(trimciv2_vMM(
    DTp2[.(levels(DTp2$Inter)[x]),"y",with=F][[1]],null.value = .25, alternative = "greater")))
  
  # Organizes and interprets the information from the two Wilcox functions
   # (D.akp.effect.ci and trimciv2), and
   # corrects p-values for directional contrasts
  Sub1<- fff3 %>% do.call("rbind",.) %>% data.table(Condition=levels(DTp2$Inter),.)  %>%
    .[estimate>.25,p.value:=p.value*2] %>% .[estimate<=.25,p.value:=(1-p.value)*2]  %>%
    .[p.value>.05,Direction:="Chance"] %>%
    .[estimate>.25&p.value<=.05,Direction:="Above"] %>% 
    .[estimate<=.25&p.value<=.05,Direction:="Balow"]  %>% 
    data.table() %>%
    data.table(.,Size=sapply(.[,Effect.Size], InterpdCohen)) %>%
      .[,p.Sig:=""] %>% .[p.value<=.05,p.Sig:="*    "]  %>% 
      data.table() %>% mutate(p.value=frmMM(p.value,4))  %>%
      data.table(.,EfSize=do.call("rbind",fff)[,2:3])  %>%
     relocate(p.Sig , .after = EfSize.ci2)  %>% 
     relocate(p.value , .after = EfSize.ci2)  %>% 
     relocate(Direction , .after = p.Sig)  %>% 
     mutate(across(c(ci1:se,Effect.Size,EfSize.ci1, EfSize.ci2), ~ as.numeric(frmMM(.,2)))) %>%
     dplyr::rename(Mean=estimate) %>% 
      data.table()
  write.csv2(Sub1,paste0(NmRoo,"/Table S6.csv"))
 
  kableTabl(Sub1,"Table S6", "")
    cat("---------------------\n");
  # Sub1
  
```

### Table S7) Complement of Figure 5. Coherency analysis

> **Table S7.** Complement of Figure 5. Coherency analysis. A) Details of 4-way ANOVA on proportion of BMR considering day \* cell type (FI vs. FS) \* context condition (within vs. across) \* coherence (1 vs. 2 BMR). dfNum indicates degrees of freedom numerator. dfDen indicates degrees of freedom denominator. SSNum indicates sum of squares numerator. SSDen indicates sum of squares denominator. η2 g indicates generalized eta-squared. B) Trend analysis of coherence 1 and 2 considering cell type x day x interaction between coherence 1 and 2. SE standard error, df degrees of freedom. Results of ANOVA revealed a main effect of the 4 factors, as well as of the interactions of order 1: Stability x Day, Stability x Coherence, and Day x Coherence; most importantly, a significant interaction between Stability x Day x Coherence (p\<.05). Detailed analysis of the significant order 2 interaction was performed using a trend analysis from day 1 to day 3, for each of the stability and coherence combinations. Detailed analysis of tendencies revealed that for FI cells, there is no significant change over days in either coherence 1 or 2 (p\>.05 for linear and quadratic). However, in FS cells, a linear change over days is obtained, which is significant for coherence 1 and 2 (p\<.05 for linear and p\>.05 for quadratic), but of opposite sign.

```{r TS7, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig5")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalMinCorr.RDS")))
  DTp<-copy(CalMinCorr)
  
  TwoDT <- DTp %>%
    .[,pChi:=prop_test(N,Ntt,p=rep(.25,4),alternative = "greater")$p, by=.(Subject,Context,Day,CellType)] %>%
    .[,p.Sig:=0] %>%  .[pChi<=.10,p.Sig:=1] %>%
    mutate(BMROrder = dplyr::recode(BMROrder, "C_1" = "1st","C_2" = "2nd" ,"C_3" = "3rd", "C_4" = "4th")) %>%
    data.table() %>%
    setkey(.,Day, CellType, Context, BMROrder)
  
  # We select only the first and second BMR levels
  TwoDT <- TwoDT %>% .[BMROrder=="1st"|BMROrder=="2nd"]
  
  
  #AOV
  IntraEz=NA
  # Due to the nesting of the factors, the optimal structure for defining the design for ANOVA:
   # BMROrder as intra variable and the rest (CellType, Context, and Day) as between
  IntraEz = ezANOVA(data = na.omit(TwoDT), 
                  dv = Perc,
                  wid = Subject,
                  within = .(BMROrder),
                  between= .(CellType, Context, Day),
                  type=3,
                  detailed = TRUE)
  ezANOVAAPA <- apa.ezANOVA.table( IntraEz,
                                  filename=paste0(NmRoo,"/ezANOVACorGG.doc"))
    
  # Polynomial analysis of the more complex significant effect:CellType:Day:BMROrder
  # For the analysis of simple effects for this interaction
   # we define the error within the combination of CellType & BMROrder
  aov.Intra <-aov(Perc ~ Day * BMROrder * Context * CellType + Error(Subject / (CellType*BMROrder)),data = TwoDT)
  em.simple.b1<-emmeans(aov.Intra,~Day|CellType|BMROrder)
  ResPostH.b2<- contrast(em.simple.b1, "poly")
  
  
  # Print Results
  # Results
    cat("Omnibus AOV:\n")
      ezANOVAAPA
    cat("---------------------\n");
    cat("Polynomial Simple Effects:\n")
      ResPostH.b2
    cat("---------------------\n")
    
```

### Fig.5F) Coherency matrices of joint probabilities

```{r F5F, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig5")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalMinCorrDetail.RDS")))
  DTp<-copy(CalminCorrDetail)
  

  CombOmit=c('C1.1_C2.1', 'C1.2_C2.2', 'C1.3_C2.3', 'C1.4_C2.4')
  LosLev=levels(interaction(paste0("C1.",1:4),paste0("C2.",1:4),sep = "_"))
  LosLevLim= LosLev[!LosLev %in% CombOmit]
  DTlev=data.table(Condition=LosLev)
  
  
  # A) Combinations of Coherence & Rotation 
  ResChiF.a<-lapply (levels(DTp$CellType), function (i){
              lapply(levels(DTp$Day), function(j) {
                lapply(levels(DTp$Context), function(k) {
                   
                  DTComFusMeans <- CreateDT.Means3(DTp,i,j,k)
                  
                  Fusgl2<-data.table(cbind(Condition="Global", Mean=round(mean(DTComFusMeans[[1]]$Mean),2), pWilcox=NA, pw.Sig=""))
                  Rsf<-data.table(Effect=paste0("Day ",j,"_Class ",k,"_CellTy ",i),
                             rbind(Fusgl2,DTComFusMeans[[1]]))
                  Rsf[, c("Mean") := lapply(.SD, function(x) frmMM(as.numeric(x),2)),
                                .SDcols = c("Mean")]
                  Rsf[, c("pWilcox") := lapply(.SD, function(x) frmMM(as.numeric(x),4)),
                                .SDcols = c("pWilcox")]
                  Rsf
      })})})
  ResChiDT1 =  data.table(do.call("rbind",unlist(unlist(ResChiF.a,recursive = F),recursive=F)))
  write.csv2(ResChiDT1, paste0(NmRoo,"/Wilcox Analysis of Means.csv"))
  
  
  # B) Marginal Analysis of each Coherence with means
  ResChiF.b<-lapply (levels(DTp$CellType), function (i){
              lapply(levels(DTp$Day), function(j) {
                lapply(levels(DTp$Context), function(k) {
                   
                  DTComFusMeans <- CreateDT.Means3(DTp,i,j,k)
                  
                   Fusgl2a<-cbind(Mean=round(mean(DTComFusMeans[[2]]$Mean),2), pWilcox=NA, pw.Sig="")
                   Fusgl2b<-cbind(Mean=round(mean(DTComFusMeans[[3]]$Mean),2), pWilcox=NA, pw.Sig="")
                   
                   Fusgl2=rbind(cbind(Condition="C1",bmr="global",Fusgl2a),
                                cbind(DTComFusMeans[[2]]),
                                cbind(Condition="C2",bmr="global",Fusgl2b),
                                cbind(DTComFusMeans[[3]]))
                   Rsfm<-data.table(Effect=paste0("Day ",j,"_Class ",k,"_Stab ",i),Fusgl2)
                   Rsfm[, c("Mean") := lapply(.SD, function(x) frmMM(as.numeric(x),2)),
                                            .SDcols = c("Mean")]
                   Rsfm[, c("pWilcox") := lapply(.SD, function(x) frmMM(as.numeric(x),4)),
                                            .SDcols = c("pWilcox")]
                   Rsfm
      })})})
  ResChiDTMarg =  data.table(do.call("rbind",unlist(unlist(ResChiF.b,recursive = F),recursive=F)))
  write.csv2(ResChiDTMarg, paste0(NmRoo,"/Wilcox Analysis of Marginal Means.csv"))
  
  
 # Print results
 kableTabl(ResChiDT1,"A) Wilcox Analysis of Means (joint probabilities", "")
 cat("---------------------\n")
 cat("---------------------\n")
 
 kableTabl(ResChiDTMarg,"B) Wilcox Analysis of Marginal Mean (BMR Order)", "")
```

The results entered in the consistency matrices are as follows.

```{r F5Fb, results='asis', collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig5")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalMinCorrDetail.RDS")))
  DTp<-copy(CalminCorrDetail)
  

  CombOmit=c('C1.1_C2.1', 'C1.2_C2.2', 'C1.3_C2.3', 'C1.4_C2.4')
  LosLev=levels(interaction(paste0("C1.",1:4),paste0("C2.",1:4),sep = "_"))
  LosLevLim= LosLev[!LosLev %in% CombOmit]
  DTlev=data.table(Condition=LosLev)
  
  
  # C) To visualize the averages used in the coherence matrices of Fig.5F
  ResChiAutomMean <- lapply (levels(DTp$CellType), function (i){
                    lapply(levels(DTp$Day), function(j) {
                      lapply(levels(DTp$Context), function(k) {
                        MatrLev2 = MkMtrSig()
                      
                        DTComFus.m <- CreateDT.Means3(DTp,i,j,k)
                        MatrLev1=frmMM(full_join(DTlev,DTComFus.m[[1]][,.(Condition,Mean)])$Mean,2)
                        MatrLev2[1:4,1:4] <-matrix(LimpMtr2(MatrLev1),nrow = 4)
                        # Marginals
                        MatrLev2[1:4,5]= frmMM(as.numeric(LimpMtr2(DTComFus.m[[2]][,Mean])),2)
                        MatrLev2[5,1:4]= frmMM(as.numeric(LimpMtr2(DTComFus.m[[3]][,Mean])),2)
                      kable_out <- kableTabl2(MatrLev2,LebelFor =paste0("Day ",j,"_Class ",k,"_CellTy ",i),NoteFor = "" )
  })})})
  save_kable(c(unlist(ResChiAutomMean)) ,paste0(NmRoo,"/Means-Wilcoxon.html"))
  
  # D) To visualize the statistical significances used in the coherency matrices of Fig.5F
  ResChiAutomSign <- lapply (levels(DTp$CellType), function (i){
                    lapply(levels(DTp$Day), function(j) {
                      lapply(levels(DTp$Context), function(k) {
                        MatrLev2 = MkMtrSig()
                      
                        DTComFus.m <- CreateDT.Means3(DTp,i,j,k)
                        MatrLev1=full_join(DTlev,DTComFus.m[[1]][,.(Condition,pw.Sig)])$pw.Sig
                        MatrLev2[1:4,1:4] <-matrix(LimpMtr(MatrLev1),nrow = 4)
                        # Marginals
                        MatrLev2[1:4,5]= LimpMtr(DTComFus.m[[2]][,pw.Sig])
                        MatrLev2[5,1:4]= LimpMtr(DTComFus.m[[3]][,pw.Sig])
                      
                      kable_out <- kableTabl2(MatrLev2,LebelFor =paste0("Day ",j,"_Class ",k,"_CellTy ",i),NoteFor = "" )
  })})})
  save_kable(c(unlist(ResChiAutomSign)) ,paste0(NmRoo,"/Means-Wilcoxon Significant.html"))
  

cat("C) Averages for the Coherency matrices of Fig.5F:\n")
 ResChiAutomMean
  cat("---------------------\n")
  
 cat("D) Statistical significances for the Coherency matrices of Fig.5F:\n") 
 ResChiAutomSign
   cat("---------------------\n")
```

# **Results Section 6.** FI cells can predict heading across time

> **Figure 6.**. FI cells can predict heading across time. A) Spatial footprints of cells identified from a representative animal on day 1 (magenta, left), day 3 (green, center), and cells identified on both days 1 and 3 (white, right) illustrating method to track cells across time. B) Pie charts showing stability of cell identity across time. Top panel shows FI and bottom panel FS percentages of registered cells that displayed stable identity (same pattern of stability across days) or unstable identity (distinct identity across days). Note that the majority of FI cells remain FI across days, whereas only a small percentage of FS cells retain their identity. C) Heading prediction accuracy using registered cells' center out angles across days. Left panel trained a classifier with neural data from day 1 to predict heading on day 2, the center panel trained with data on day 2 to predict heading on day 3, and the right panel trained with data on day 1 to predict heading on day 3. Horizontal bar chart show prediction for each animal and overall prediction (gray)  standard error of the mean (SEM). Asterisks represent p ≤ .05 (*), p ≤ .01 (**) or p ≤.001 (***), \# indicates a trend approaching the significance level we set at .05 (p = 0.0502).

> **Figure S13.**. Complement of Figure 6. A) Registration quality per decile. To determine if the registration quality influenced the remapping properties across context, we used the registration score index (range = 0--1) developed by Sheintuch et al. (2017), which is provided by the CellReg algorithm. This value evaluates the registration certainty of all cell-pairs within the population of registered cells by computing the footprint spatial correlations for each cell across days. Spatial registration quality was evaluated for any cell present during at least 2 days of testing by dividing the average correlation across context distribution in deciles. There were no significant differences in footprint quality across deciles \[F(9, 1317) = 0.88, p = .54\]. This indicates that changes in stability across time are not due to differences in spatial registration quality. B) Change in context similarity across days per decile. The absolute difference in correlations for all registered cells was calculated for each day pair by dividing the cells into the same deciles described in panel A. The data show that cells in decile 1 displayed more significant differences in similarity scores across context than cells from other deciles (Day 1 to Day 2: F(9,279) = 8.78, p \< .0001; Day 1 to Day 3: F(9, 262) = 3.94, p \< .0001; Day 2 to Day 3: F(9,226) = 3.93, p \< .0001, Pos Hoc multiple comparisons shown in the graph). All of the graphs correspond to Boxplots, in which the boxes indicate the upper and lower quartiles of the data and the whiskers (extending lines) the minimum and maximum outside the quartiles. The horizontal line indicates the median, and + indicates the presence of outliers. Asterisks represent p ≤ .05 (*), p ≤ .01 (**) or p ≤ .001 (***), \# indicates a trend approaching the significance level we set at .05.

### Fig.S13) Registration quality per decile & Change in context similarity across days per decile

#### Fig.S13A) Registration quality per decile

![Figure 13A (see `Grp.13A` code to generate this image)](images/Fig13A.png){width="400"}

```{r FS13A, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig6")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CalciumCellRegsScores.RDS")))
  DTp<-copy(CalciumCellRegsScores)
  
  # "Fig.13A) has been preloaded to avoid overloading problems
  # Box Plot
  Grp.S13A<-ggplot2::ggplot(data=DTp, aes(x=Decile, y=Score, fill=factor(Decile))) +
    geom_boxplot(staplewidth = .5) + scale_fill_manual(values=decilecolors) + theme_bw_MM() + theme(legend.position = "none") +
    ylab("Cell Registration Score")
  ggsave(paste0(NmRoo,"/FigS13A.pdf"), Grp.S13A ,width = 12,height = 6)
  
  # Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Score', by=.(Decile)]
  write.csv2(DTRes,paste0(NmRoo, "/CalciumCellRegsScores_Descriptive.csv"))  

  # AOV Omnibus & Pos Hoc
  AOVMain<-aov(Score~Decile,DTp)
  
  # Since there are no significant differences in the AOV, then Pos Hoc is not applicable.
  
  # Print Results
  a0<-summary(AOVMain)
  PosH.4w<-list()
  PosH.4w$PosHocMM <-NULL
  PosH.4w$Means <- NULL
  Grp<-"Run Grp.S13A"
  # Grp.S13A
  <<ResCtrl1>>
    
  
```

#### Fig.S13B) Change in context similarity across days per decile

{Design 10 Decile x 3 Day} Robust

![Figure 13B (see `Grp.13B` code to generate this image)](images/Fig13B.png){width="400"}

The **`RobSisOne`** function allows to extract the statistics needed for a robust ANOVA from the relevant Wilcox' functions. Firstly the **omnibus** AOV and secondly the **Pos Hoc** simple effects analysis. In addition, **effect size estimates** as well as relevant descriptive statistics are added in both approaches to facilitate power estimates or meta-analysis studies.

```{r FS13B, warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse = FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig6")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/CellRegsCountBetweenDays.RDS")))
  DTp<-copy(CellRegsCountBetweenDays)
  
  # "Fig.13B) has been preloaded to avoid overloading problems
  # Box Plot
  Grp.S13B<-ggplot2::ggplot(data=DTp, aes(x=Decile, y=Correlation, fill=factor(Decile))) +
    geom_boxplot(staplewidth = .5) + scale_fill_manual(values=decilecolors) + theme_bw_MM() + theme(legend.position = "none") +
    facet_wrap(~Day) + ylab("Absolute Correlation Difference")
  ggsave(paste0(NmRoo,"/FigS13B.pdf"), Grp.S13B ,width = 12,height = 6)
  
  # Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Correlation', by=.(Day,Decile)]
  write.csv2(DTRes,paste0(NmRoo, "/CellRegsCountBetweenDays_Descriptive.csv"))  

  # AOV Omnibus & Pos Hoc
  # The "RobSisOne" function allows to extract the statistics needed for a robust ANOVA from the relevant Wilcox' functions
  RobRes1<-RobSisOne(DTFisp = DTp , IdSj = "Subject",wv1="Day",wv2="Decile",LaVd="Correlation")
  write.csv2(RobRes1$SimplEfb.1,"CellRegsCountBetweenDays_PosHoc.csv")
  
  
  # Print Results
  # Results
    kableTabl(ezPrecis(DTp),"Design Structure", "")
    cat("---------------------\n");
    cat("Data Structure:\n");
      str(DTp) # Data File
    cat("---------------------\n");
      print(DTp)
    cat("---------------------\n");
      kableTabl(DTRes,"Descriptive", "")
    cat("---------------------\n");
    
    cat("1) Robust One-way of the Deciles for each of the pairs of days:\n")
    cat("(see legend text of Figure S13B)):\n")
      RobRes1$Omn
    cat("---------------------\n");
    cat("---------------------\n");
    cat("2) Robust Pos Hoc of the Deciles for each of the pairs of days:\n")
    cat("(see asterisks at the top of the Figure S13B):\n")
      kableTabl(RobRes1$SimplEfb.1,"Pos Hoc", "")
    cat("---------------------\n");
    
    cat("\n")
    cat("\n")
    # cat("Graphics have been preloaded to avoid page overload\n (see the corresponding section for details).:\n");
    cat("Exploratory Analysis:\n")
    cat("Run Grp.S13B")
    # Grp.S13B
    cat("\n")
    
```

# **Results Section 7.** Firing rate predicts context and reorientation behavior by integrating featural and geometric information

## **Figure 7. Firing rate predicts context and reorientation behavior by integrating featural and geometric information.**

> **Figure 7.** Firing rate predicts context and reorientation behavior by integrating featural and geometric information. A) Schematic of method used to calculate rate matrices based on the absolute rate difference between trials. Quadrants with black contour depict rate differences within context (upper quadrant context A and bottom quadrant context B). Quadrants without black contour depict rate differences across context. Rate matrices are computed for each cell and averaged per animal B) Histograms showing average rate difference within and across context trial comparisons on days 1 to 3. Dots indicate individual cell data. C) Matrices showing average of rate difference across cells recorded on day 1 (left), 2 (center), and 3 (right) showing increased rate differences across context with training. D) Schematic of prediction method. The mean firing rates in each trial group are used to train a support vector machine (SVM) for binary classification, cross-validated using a leave-one-out procedure. E) Context prediction. C or G search trials in Context A (green) and Context B (red) are used to train a SVM to predict context in a withheld trial (top). Context prediction accuracy is significant on days 2 and 3 (bottom). F) Heading prediction. C trials and G trials in both contexts are used to predict digging side (top). C and G search digs are reliably predicted on days 2 and 3, with a trend on day 1 (bottom). C= correct, G= geometric error. Asterisks (\*) represent p \< 0.05. Error bars denote ± 1 SEM.

### Fig.7B) Histograms showing average rate difference within and across context trial comparisons on days 1 to 3

{Design (2 Context x S) x 3 Day} Robust

The **`RobSis24`** function allows to extract the statistics needed for a robust ANOVA from the relevant Wilcox' functions for a repeated measures design with a factor between and an within factor. Firstly the **omnibus** AOV and secondly the **Pos Hoc** simple effects analysis. In addition, **effect size estimates** as well as relevant descriptive statistics are added in both approaches to facilitate power estimates or meta-analysis studies.

![Figure 7B (see `Grp.7B` code to generate this image)](images/Fig7B.png){width="400"}

```{r F7B, warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig7")
  Mk.dir(NmRoo)
  
  #DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/RateRemap.RDS")))
  DTp<-copy(RateRemap)
  
  DTp2 <- DTp %>% 
      mutate(Context = dplyr::recode(Context, "within"="Within Context","across"="Across Context")) %>%
      data.table()
      
  
# "Fig.7B) has been preloaded to avoid overloading problems
# Bar Plot with jitters points
    ColPer<-c("#FAAF3B", "#8CC540")
    Grp.7B<- Grph.2023(
    DatP = DTp2,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "","Rate Difference (Hz)","Day"),
      ylmP =c(0,1),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Bar", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=F,ColPer=ColPer
  )
    Grp.7B <- Grp.7B + geom_jitter(position=position_jitter(0.2), color="black", size=1.0, alpha=0.9, pch=21)
    ggsave(paste0(NmRoo,"/Fig7B.pdf"), Grp.7B, width=10, height=10)
    
# Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Rate', by=.(Day,Context)]
  write.csv2(DTRes,paste0(NmRoo, "/RateRemap_Descriptive.csv"))  
  
  
  
# AOV Omnibus & Pos Hoc
  # The "RobSis24" function allows to extract the statistics needed for a robust ANOVA from the relevant Wilcox' functions
  RobRes1<-RobSis24(DTFisp = DTp , IdSj = "Subject",wv1="Context",wv2="Day",LaVd="Rate")
  
  # Print Results
  a0<-RobRes1$Omn
  PosH.4w<-list()
  PosH.4w$PosHocMM <-RobRes1$SimplEfa.2
  PosH.4w$Means <- RobRes1$SimplEfa.1
  Grp<-"Run Grp.7B"
  # Grp.7B
  <<ResCtrl1>>
```

### Fig.S15) Mean and peak firing rate

> **Figure S15.** Complement of Figure 7. Mean (A) and peak (B) firing rate changes within and across context provide similar differences using different occupancy thresholds, with the mean firing rate being slightly more consistent across conditions of occupancy. The results were equivalent across the variations of minimum occupancy (50%, 60%, and 70%) and measurement of rate differences (peak and mean firing rate). To compare the occupancy parameters, an analysis of effect sizes was performed. The Within-Across effect sizes were equivalent across occupancy and measurement conditions (day 1: p=0.97; day 2: p=0.16, day 3: p=0.99). Table S8A shows effect size for each condition.

{Design (2 Context x S) x 3 Day} Robust

Use the function **`RobSis24`**, as in Fig.7B

![Figure S15 (see `Grp.S15` code to generate this image)](images/FigS15.png){width="400"}

```{r FS15,  warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig7")
  Mk.dir(NmRoo)
  
  #Example:
  # DTp.a1 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/RateRemapMean_0_5.RDS")))
  # ... DTp.a6 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/RateRemapPeak_0_7.RDS")))
  DTp.a1<-copy(RateRemapMean_0_5)
  DTp.a2<-copy(RateRemapMean_0_6)
  DTp.a3<-copy(RateRemapMean_0_7)
  DTp.b1<-copy(RateRemapPeak_0_5)
  DTp.b2<-copy(RateRemapPeak_0_6)
  DTp.b3<-copy(RateRemapPeak_0_7)
  
  DTp2.a1 <- DTp.a1 %>% 
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      data.table()
  DTp2.a2 <- DTp.a2 %>% 
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      data.table()
  DTp2.a3 <- DTp.a3 %>% 
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      data.table()
  DTp2.b1 <- DTp.b1 %>% 
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      data.table()
  DTp2.b2 <- DTp.b2 %>% 
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      data.table()
  DTp2.b3 <- DTp.b3 %>% 
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      data.table()
  
#A) Exploratory analysis

    ColPer<-c("#FAAF3B", "#8CC540")
# Box Plot MFR 0.5    
    Grp.S15.a1<- Grph.2023(
    DatP = DTp2.a1,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "50%","Rate Difference (Hz)","Day"),
      ylmP =c(0,.4),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )
   
  # Box Plot MFR 0.6
    Grp.S15.a2<- Grph.2023(
    DatP = DTp2.a2,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "60%","Rate Difference (Hz)","Day"),
      ylmP =c(0,.4),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )   
  
  # Box Plot MFR 0.7
    Grp.S15.a3<- Grph.2023(
    DatP = DTp2.a3,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "70%","Rate Difference (Hz)","Day"),
      ylmP =c(0,.4),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )     
  
  # Box Plot PFR 0.5    
    Grp.S15.b1<- Grph.2023(
    DatP = DTp2.b1,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "50%","Rate Difference (Hz)","Day"),
      ylmP =c(0,60),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )
   
  # Box Plot PFR 0.6
    Grp.S15.b2<- Grph.2023(
    DatP = DTp2.b2,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "60%","Rate Difference (Hz)","Day"),
      ylmP =c(0,60),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )   
  
  # Box Plot PFR 0.7
    Grp.S15.b3<- Grph.2023(
    DatP = DTp2.b3,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "70%","Rate Difference (Hz)","Day"),
      ylmP =c(0,60),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )    

  Grp.S15 <- plot_grid(Grp.S15.a1, Grp.S15.a2, Grp.S15.a3, Grp.S15.b1, Grp.S15.b2, Grp.S15.b3,labels = c("","          mean firing rate","","","          peak firing rate"))
  ggsave(paste0(NmRoo,"/FigS15.pdf"), Grp.S15 ,width = 22,height = 14)  
  
  
  
  
#B) Comparative analysis through effect size
  OrdPar<-list(DTp.a1,DTp.a2,DTp.a3,DTp.b1, DTp.b2, DTp.b3)
  RobResf <- lapply(OrdPar, function(ii) RobSis24(DTFisp = ii , IdSj = "Subject",wv1="Context",wv2="Day",LaVd="Rate"))
  for ( i in 1:6) setkey (RobResf[[i]]$SimplEfa.1, IV1)
  
  for ( i in 1:6) setkey (RobResf[[i]]$Dif, x2)
  EfDay1<- lapply(lapply(lapply(RobResf, "[[", "Dif"),"[",'Day 1'),"[[",'Difference')
  EfDay2<- lapply(lapply(lapply(RobResf, "[[", "Dif"),"[",'Day 2'),"[[",'Difference')
  EfDay3<- lapply(lapply(lapply(RobResf, "[[", "Dif"),"[",'Day 3'),"[[",'Difference')
  
  ContrEfSizD1<-rmES.pro(EfDay1,PV = T)
  ContrEfSizD2<-rmES.pro(EfDay2,PV = T)
  ContrEfSizD3<-rmES.pro(EfDay3,PV = T)
  
  
  
  # Print results
  cat("\n")
  cat("\n")
  cat("Graphics have been preloaded to avoid page overload\n")
  cat("Run Grp.S15 code\n")
  # Grp.S15
  
  cat("To compare the 6 occupancy parameters,\n an analysis of effect sizes was performed\n. A test of statistical significance between all the effect sizes for each of the days\n showed that Within-Across effect sizes were equivalent across occupancy and measurement conditions:\n")
  paste0("Day 1: ", ContrEfSizD1$p.value, "; Day 2: ", ContrEfSizD2$p.value, "; Day 3: ", ContrEfSizD3$p.value)    
  
```

### Fig.S16) Differences in firing rate within and across context in FI and FS cells, Heading prediction & Context Prediction

> **Figure S16**. Complement of figure 7. A-B. Differences in firing rate within and across context in FI (A) and FS (B) cells. The absolute value of the mean firing rate difference was calculated for all pairwise cell comparisons within context and across context. FI displayed the same trend observed in the population, showing no differences on day 1 (p\>.05), and differences on days 2 and 3 (p\<.05). FS cells did not show significant differences on any day (p\>.05). The absence of positive results might stem from the limited yield of electrophysiology data, posing challenges in the analysis of the properties of these cells. However, it is worth noting that the trend in FS cells is the same observed in FI cells: non-significant on day 1 and near significance on days 2 and 3 (see Table S8B for details). Therefore, it is likely that rate changes affect the whole active ensemble. To strengthen these conclusions, an analysis of effect size was performed. The Within-Across effect sizes were equivalent in both cell types (Table S8B). C. Heading prediction per cell type using rate. FI cells (mean prediction accuracy and level of significance): Day 1: mean: 60.85.7%, p=0.054; Day 2: mean: 73.65.8%, p\<.01; Day 3: mean: 66.55.1%, p\<.05. FS cells (mean prediction accuracy and level of significance): Day 1: mean: 63.70 4.70%, p\<.05; Day 2: mean: 73.301.70%, p\<.01; Day 3: mean: 65.103.90%, p\<.05. D. Context prediction per cell type using rate. FI cells cells (mean prediction accuracy and level of significance): Day 1: mean: 57.003.76%, p=.06; Day 2: mean: 63.95.6%, p\<.05; Day 3: mean: 75.764.80%, p\<.01. FS cells (mean prediction accuracy and level of significance): Day 1: mean: 59.84 2.50%, p\<.02; Day 2: mean: 74.2 12.9%, p=.10; Day 3: mean: 64.312.30%, p=.18. Critically, there were no significant differences between FI and FS across days either for context or heading predictions (p\>.05). Together, our data suggest that rate changes integrate information about geometry and features.

#### Fig.S16AB) Differences in firing rate within and across context in FI and FS cells

{Design (2 Context x S) x 3 Day x 2 CellType} Robust

Use the function **`RobSis24`**, as in Fig.7B

![Figure S16AB (see `Grp.S16AB` code to generate this image)](images/FigS16A.png){width="400"}

```{r FS16AB,  warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig7")
  Mk.dir(NmRoo)
  
  # DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/RateRemapCellType.RDS")))
  DTp<-copy(RateRemapCellType)

  DTp2 <- DTp %>% 
      mutate(Context = factor(Context, levels = c("Within", "Across"))) %>%
      mutate(Context = dplyr::recode(Context, "Within"="Within Context","Across"="Across Context")) %>%
      mutate(CellType = dplyr::recode(CellType, "FI"="FI Cells","FS"="FS Cells")) %>%
      data.table()

    
  # A) Exploratory analysis

    ColPer<-c("#FAAF3B", "#8CC540")
# Box Plot
    Grp.S16AB<- Grph.2023(
    DatP = DTp2,
      Dvp="Rate", VarX="Day",VarFill="Context",
      LblsP =c("Cluster Quality", "","Absolute Rate Difference (Hz)","Day"),
      ylmP =c(0,.6),hLin = F,lvIp = 3,GrpSel = c(1:2),wMain=F,
    TyGrp="Box", # Bar, Box, Violin, SplitViolin
    Wthdot=F, Relleno=T, ResumAd=T,ColPer=ColPer
  )
  Grp.S16AB <- Grp.S16AB + facet_grid( ~ CellType)
  ggsave(paste0(NmRoo,"/FigS16AB.pdf"), Grp.S16AB, width=14, height=10)
  
  
# Descriptive
  DTRes<-DTp[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Rate', by=.(Day,Context,CellType)]
  write.csv2(DTRes,paste0(NmRoo, "/RateRemapCellType_Descriptive.csv"))  
  
  
# B) AOV & Pos Hoc, with Effect Sizes
  # for each cell type separately, in order to facilitate comparison with the results of the preceding analyses
  # The "RobSis24" function allows to extract the statistics needed for a robust ANOVA from the relevant Wilcox' functions
  OrdPar<-list(DTp[CellType=="FI"], DTp[CellType=="FS"])
  RobResf <- lapply(OrdPar, function(ii) RobSis24(DTFisp = ii , IdSj = "Subject",wv1="Context",wv2="Day",LaVd="Rate"))
  
  
  
  # Results
    kableTabl(ezPrecis(DTp),"Design Structure", "")
    cat("---------------------\n");
    cat("Data Structure:\n");
      str(DTp) # Data File
    cat("---------------------\n");
      print(DTp)
    cat("---------------------\n");
      kableTabl(DTRes,"Descriptive", "")
    cat("---------------------\n");
    
    cat(" For FI Cells\n")
    cat("Omnibus Robust AOV:\n")
      RobResf[[1]]$Omn
    cat("---------------------\n");
    cat("Robust Pos Hoc Simple Effects:\n")
      RobResf[[1]]$SimplEfa.2
    cat("---------------------\n");
    kableTabl(RobResf[[1]]$SimplEfa.1,"Descrptive & CI-95% for FI Cells", "")
    cat("---------------------\n");
    
    cat(" For FS Cells\n")
    cat("Omnibus Robust AOV:\n")
      RobResf[[2]]$Omn
    cat("---------------------\n");
    cat("Robust Pos Hoc Simple Effects:\n")
      RobResf[[2]]$SimplEfa.2
    cat("---------------------\n");
    kableTabl(RobResf[[2]]$SimplEfa.1,"Descrptive & CI-95% for FS Cells", "")
    cat("---------------------\n");
    
    cat("\n")
    cat("\n")
    # cat("Graphics have been preloaded to avoid page overload\n (see the corresponding section for details).:\n");
    cat("Exploratory Analysis:\n")
    cat("Run Grp.S16AB")
    #Grp.S16AB
    cat("\n")
  
```

#### Fig.S16CD) Heading prediction and Context prediction per cell type using rate

{Design (2 CellType x S) x 3 Day}

![Figure S16CD (see `Grp.S16CD` code to generate this image)](images/FigS16CD.png){width="400"}

```{r FS16CD,  warning=FALSE, message=FALSE, out.width="800px", out.height="600px", collapse=FALSE}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig7")
  Mk.dir(NmRoo)
  
  # DTp <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/HeadingAndContextPrediction.RDS")))
  DTp<-copy(HeadingAndContextPrediction)

  DTp2 <- DTp %>% 
      mutate(Accuracy=Accuracy*100) %>% 
      data.table()

    
  # A) Exploratory analysis

# Box Plot
    ColPer=c("#838BC5","coral3")
    Grp.S16CD<- Grph.2023b(
      DatP = DTp2,
      Dvp="Accuracy", VarX="Day", VarFill="CellType",
      LblsP =c("Cluster Quality", "","Prediction Accuracy (%)",""),
      ylmP =c(0,100),hLin = F,lvIp = 4,GrpSel = c(1:3),wMain=F,
      TyGrp="Box", # Bar, Box, Violin, SplitViolin
      Wthdot=F, Relleno=T, ResumAd=F,ColPer=ColPer
    )
    Grp.S16CD <- Grp.S16CD  + facet_wrap(~Context) + geom_hline(yintercept=50, linetype="dashed", color = "gray30")
    ggsave(paste0(NmRoo,"/FigS16CD.pdf"), Grp.S16CD, width=14, height=10)
  
  
# Descriptive
  DTRes<-DTp2[, rbindlist(lapply(.SD, stats_MM)), .SDcols = 'Accuracy', by=.(Day,Context,CellType)]
  write.csv2(DTRes,paste0(NmRoo, "/HeadingAndContextPrediction_Descriptive.csv"))  
  
  
# B) AOV & Pos Hoc, with Effect Sizes
  # One-sample statistical tests in which the null hypothesis of chance (0.5) is tested.
  LosLevInt=levels(DTp$Inter)
  ptTest1 <-c(do.call("rbind",lapply(1:6, function(ll) 
      t.test(DTp[Context=="Heading Prediction"&Inter==LosLevInt[[ll]]]$Accuracy,
                                                                      mu = 1/2, alternative = "greater")$p.value)))
  ptTest2 <-c(do.call("rbind",lapply(1:6, function(ll) 
      t.test(DTp[Context=="Context Prediction"&Inter==LosLevInt[[ll]]]$Accuracy,
                                                                      mu = 1/2, alternative = "greater")$p.value)))
  names(ptTest1)<-names(ptTest2) <-LosLevInt
  
  # two-sample differences between CellTypes on each Day
  PosHoc1<- c(do.call("rbind",lapply(levels(DTp$Day), function(ll) t.test(DTp[Context=="Heading Prediction"&Day==ll&CellType=="FI Cells"]$Accuracy,
                                                     DTp[Context=="Heading Prediction"&Day==ll&CellType=="FS Cells"]$Accuracy,paired = T)$p.value)))
  
  PosHoc2<-c(do.call("rbind",lapply(levels(DTp$Day), function(ll) t.test(DTp[Context=="Context Prediction"&Day==ll&CellType=="FI Cells"]$Accuracy,
                                                     DTp[Context=="Context Prediction"&Day==ll&CellType=="FS Cells"]$Accuracy,paired = T)$p.value)))
  names(PosHoc1)<-names(PosHoc2) <-levels(DTp$Day) 
   
  
  
  
  # Results
    kableTabl(ezPrecis(DTp),"Design Structure", "")
    cat("---------------------\n");
    cat("Data Structure:\n");
      str(DTp) # Data File
    cat("---------------------\n");
      print(DTp)
    cat("---------------------\n");
      kableTabl(DTRes,"Descriptive", "")
    cat("---------------------\n");
    
    cat("1) probabilities of One-sample statistical tests in which the null hypothesis of chance (0.5) is tested:\n")
    cat(" For Heading Prediction\n")
    cat("(see asterisks at the top of the Figure S16C):\n")
      ptTest1
    cat("---------------------\n");
    cat(" For Context Prediction\n")
    cat("(see asterisks at the top of the Figure S16D):\n")
      ptTest2
    
    cat("---------------------\n");  
    cat("(or legend text for Heading Prediction):\n")
    cat("For FI Cells: \n")
    cbind(DTRes[Context=="Heading Prediction"&CellType=="FI Cells", .( Context, CellType, Day,Mean,SEM)],
          Probabilities=ptTest1[grep("FI",names(ptTest1),value = TRUE)])
    cat("For FS Cells: \n")
    cbind(DTRes[Context=="Heading Prediction"&CellType=="FS Cells", .( Context, CellType, Day, Mean,SEM)],
          Probabilities=ptTest1[grep("FS",names(ptTest1),value = TRUE)])
    cat("---------------------\n");    
    cat("(or legend text for Context Prediction):\n")  
      cat("For FI Cells: \n")
    cbind(DTRes[Context=="Context Prediction"&CellType=="FI Cells", .( Context, CellType, Day,Mean,SEM)],
          Probabilities=ptTest2[grep("FI",names(ptTest2),value = TRUE)])
    cat("For FS Cells: \n")
    cbind(DTRes[Context=="Context Prediction"&CellType=="FS Cells", .( Context, CellType, Day, Mean,SEM)],
          Probabilities=ptTest2[grep("FS",names(ptTest2),value = TRUE)])
    
    cat("---------------------\n");
    cat("---------------------\n");
    cat("\n")
    cat("\n")
    cat("2) Probabilities of two-sample differences between CellTypes on each Day:\n")
    cat(" For Heading Prediction\n")
    cat("(see asterisks in the second line from the top of the Figure S16C):\n")
      PosHoc1
    cat("---------------------\n");
    cat(" For Context Prediction\n")
    cat("(see asterisks in the second line from the top of the Figure S16D):\n")
      PosHoc2
    cat("---------------------\n");
    cat("---------------------\n");
    cat("Conclusion: Critically, there were no significant differences between FI and FS\n across days either for context or heading predictions (p >.05\n")
    
    
    cat("\n")
    cat("\n")
    # cat("Graphics have been preloaded to avoid page overload\n (see the corresponding section for details).:\n");
    cat("Exploratory Analysis:\n")
    cat("Run Grp.S16CD")
    #Grp.S16CD
    cat("\n")
  
```

### Table S8) Comparison of effect size for rate remapping within and across context throughout the days

> **Table S8.** Complement of Figures 7, S10, S11, and S12. Comparison of effect size for rate remapping within and across context throughout the days. A) Comparison of effect size of mean rate remapping for FS and FI cells. B) Comparison of effect size using occupancy thresholds 50%, 60%, 70% for mean (left) and peak (right) firing rate differences.

Use the function **`RobSis24`**, as in Fig.7B

```{r TS8,  warning=FALSE, message=FALSE, out.width="800px", out.height="600px"}
  if(!exists('FxDir')) source(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/SupportNeuroSpatial.R")))
  NmRoo = paste0(DirPath,"/", "Fig7")
  Mk.dir(NmRoo)
  
  
# Table S8A) Comparison of effect size of mean rate remapping for FS and FI cells
  DTp<-copy(RateRemapCellType)
  
  OrdParA<-list(DTp[CellType=="FI"], DTp[CellType=="FS"])
  RobResfA <- lapply(OrdParA, function(ii) RobSis24(DTFisp = ii , IdSj = "Subject",wv1="Context",wv2="Day",LaVd="Rate"))
  for ( i in 1:2) setkey (RobResfA[[i]]$SimplEfa.1, IV1)
  
  ExtrEfA<-    data.table(do.call("rbind", lapply(lapply(RobResfA, "[[", "SimplEfa.1"),"[[",'Effect.Size')))
  ExtrPRomA<-  data.table(do.call("rbind", lapply(lapply(RobResfA, "[[", "SimplEfa.1"),"[[",'p.Rom')))
  names(ExtrEfA) <-names(ExtrPRomA) <-c("Day.1", "Day.2", "Day.3")
  
  Table.S8A<-data.table(cbind("Cell Type" = rep(c("FI","FS"),each=3),
                  "Day" = rep(c(1:3),2),
                  "MFR.p(within-across)"= frmMM(c(t(ExtrPRomA)),4),
                  "MFR.Effect size (𝛏)" = frmMM(c(t(ExtrEfA)),2)
               ))
  
  
# Table S8B) Comparison of effect size using occupancy thresholds 50%, 60%, 70% for mean and peak firing rate differences  
  #Example:
  # DTp.a1 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/RateRemapMean_0_5.RDS")))
  # ... DTp.a6 <- readRDS(gzcon(url("https://github.com/ManuMi68/MuLaNa2/raw/main/NeuroSpatialData/RateRemapPeak_0_7.RDS")))
  DTp.a1<-copy(RateRemapMean_0_5)
  DTp.a2<-copy(RateRemapMean_0_6)
  DTp.a3<-copy(RateRemapMean_0_7)
  DTp.b1<-copy(RateRemapPeak_0_5)
  DTp.b2<-copy(RateRemapPeak_0_6)
  DTp.b3<-copy(RateRemapPeak_0_7)
  
  OrdParB<-list(DTp.a1,DTp.a2,DTp.a3,DTp.b1, DTp.b2, DTp.b3)
  RobResfB <- lapply(OrdParB, function(ii) RobSis24(DTFisp = ii , IdSj = "Subject",wv1="Context",wv2="Day",LaVd="Rate"))
  for ( i in 1:6) setkey (RobResfB[[i]]$SimplEfa.1, IV1)
  
  ExtrEfB<-    data.table(do.call("rbind", lapply(lapply(RobResfB, "[[", "SimplEfa.1"),"[[",'Effect.Size')))
  ExtrPRomB<-  data.table(do.call("rbind", lapply(lapply(RobResfB, "[[", "SimplEfa.1"),"[[",'p.Rom')))
  names(ExtrEfB) <-names(ExtrPRomB) <-c("Day.1", "Day.2", "Day.3")
  
  Table.S8B<-data.table(cbind("Threshold" = rep(c("50%","60%","70%"),each=3),
                  "Day" = rep(c(1:3),3),
                  "MFR.p(within-across)"= c(t(ExtrPRomB[1:3])),
                  "MFR.Effect size (𝛏)" = c(t(ExtrEfB[1:3])),
                  "PFR.p(within-across)"= c(t(ExtrPRomB[4:6])),
                  "PFR.Effect size (𝛏)" = c(t(ExtrEfB[4:6]))
               ))
  
  # Graphical alternative to the Table S8B
  AllSizeIntraB <-cbind(DepVar = rep(c("MFR","PFR"),each=3), Threshold= rep(c("50%","60%","70%"),2),ExtrEfB) %>% 
    mutate_at(c('DepVar', 'Threshold'),factor) %>% 
    mutate_at(c('Day.1', 'Day.2', 'Day.3'),as.numeric) %>%
    pivot_longer(cols = `Day.1`:`Day.3`, 
               names_to = "Day", values_to = 'Effect.Size')
  grpTable.S8B <-ggplot(AllSizeIntraB, aes(x=Day, y =Effect.Size, group=1)) + 
    geom_point(data=AllSizeIntraB, aes(x = Day, y = Effect.Size), size=3) + 
    geom_line(linewidth=1) + theme_classic() + facet_grid(DepVar~Threshold) + ylab("Effect Size")
  
  
  # Print Results
  kableTabl(Table.S8A,"Table S8A. Comparison of effect size of mean rate remapping for FS and FI cells", "")
  kableTabl(Table.S8B,"Table S8B. Comparison of effect size using occupancy thresholds 50%, 60%, 70% for mean and peak firing rate differences", "")
```
